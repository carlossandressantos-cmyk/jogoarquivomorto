<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arquivo Morto - Evidência</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Special+Elite&display=swap" rel="stylesheet">
    <style>
        /* Estilos Personalizados para o tema Investigação */
        body {
            font-family: 'Courier Prime', monospace;
            background-color: #1a1a1a;
            color: #e5e5e5;
            overflow-x: hidden;
        }

        .title-font {
            font-family: 'Special Elite', cursive;
        }

        /* Efeito de papel velho/textura */
        .paper-texture {
            background-color: #f0f0f0;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.9)),
                url('https://www.transparenttextures.com/patterns/aged-paper.png');
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Efeito de fita de cena de crime */
        .crime-tape {
            background: repeating-linear-gradient(
                45deg,
                #fbbf24,
                #fbbf24 10px,
                #000 10px,
                #000 20px
            );
        }

        /* Animação de carimbo */
        .stamp-animate {
            animation: stamp-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0;
            transform: scale(3) rotate(-15deg);
        }

        @keyframes stamp-in {
            to {
                opacity: 1;
                transform: scale(1) rotate(-15deg);
            }
        }

        /* Background placeholder */
        .bg-investigation {
            background-color: #000000;
            background-image: url('https://github.com/carlossandressantos-cmyk/jogoarquivomorto/blob/main/fundo-site.png?raw=true');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        /* Animação de piscar para as palavras selecionadas */
        @keyframes blink-alert {
            0%, 100% { opacity: 1; text-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
            50% { opacity: 0.4; text-shadow: none; }
        }
        
        .blinking-text {
            animation: blink-alert 1.5s infinite;
        }

        /* Animação de piscar forte (PULSE) para o logo na tela inicial */
        @keyframes strong-pulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1); 
                filter: drop-shadow(0 0 15px rgba(200, 0, 0, 0.5));
            }
            50% { 
                opacity: 0.2; /* Opacidade bem baixa para parecer que está piscando */
                transform: scale(0.95); 
                filter: drop-shadow(0 0 0 rgba(0,0,0,0));
            }
        }

        .logo-breath {
            animation: strong-pulse 1.5s ease-in-out infinite;
        }

        /* Animação de Giro da Carta */
        @keyframes spin-card {
            0% { transform: rotateY(0deg) scale(1); }
            50% { transform: rotateY(900deg) scale(1.1); }
            100% { transform: rotateY(1800deg) scale(1); }
        }

        .card-spinning {
            animation: spin-card 3s ease-out forwards;
            pointer-events: none; 
        }

        .perspective-container {
            perspective: 1000px;
        }

        /* Transição suave para esconder a tela inicial */
        .fade-out {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.8s ease-out;
        }

        /* Scrollbar customizada */
        .word-list-container::-webkit-scrollbar { width: 8px; }
        .word-list-container::-webkit-scrollbar-track { background: #e5e5e5; }
        .word-list-container::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
    </style>
</head>
<body class="bg-investigation min-h-screen flex flex-col items-center justify-start p-4">

    <!-- ÁUDIO DE FUNDO -->
    <audio id="bg-music" loop>
        <source src="https://files.catbox.moe/tni4fx.mp3" type="audio/mpeg">
    </audio>

    <!-- BOTÃO DE SOM -->
    <button id="audio-toggle" class="fixed top-4 right-4 z-[60] p-3 bg-black/80 text-red-600 border border-red-800 rounded-full hover:bg-red-900/50 transition-all shadow-lg backdrop-blur-sm group">
        <svg id="icon-sound-on" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
        </svg>
        <svg id="icon-sound-off" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
        </svg>
    </button>

    <!-- TELA INICIAL (Splash Screen) -->
    <div id="splash-screen" class="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center p-4">
        <div class="absolute inset-0 bg-investigation opacity-50"></div>
        <div class="absolute inset-0 bg-black opacity-60"></div>

        <div class="relative z-10 flex flex-col items-center text-center">
            <img src="https://github.com/carlossandressantos-cmyk/jogoarquivomorto/blob/main/logo-site.png?raw=true" 
                 alt="Arquivo Morto Logo" 
                 class="h-48 md:h-64 object-contain mb-8 logo-breath drop-shadow-2xl">
            
            <div class="text-gray-400 text-sm tracking-[0.2em] mb-12 font-bold uppercase">
                Acesso Restrito // Departamento de Casos Frios
            </div>

            <button id="btn-start-game" class="group relative px-8 py-4 bg-transparent border-2 border-red-800 text-red-600 font-bold text-xl uppercase tracking-widest hover:bg-red-900/20 hover:text-red-500 hover:border-red-600 transition-all duration-300">
                <span class="absolute inset-0 w-full h-full bg-red-800/10 opacity-0 group-hover:opacity-100 transition-opacity"></span>
                <span class="relative flex items-center gap-2">
                    <span class="w-2 h-2 bg-red-600 rounded-full animate-pulse"></span>
                    Iniciar Investigação
                </span>
            </button>
            <p id="loading-msg" class="text-white mt-4 text-xs animate-pulse">Estabelecendo conexão segura...</p>
        </div>
        <div class="absolute bottom-8 text-gray-600 text-xs font-mono">
            SISTEMA ONLINE v3.0 | <span id="online-count">1</span> AGENTES CONECTADOS
        </div>
    </div>

    <!-- Container Principal -->
    <div id="main-game-container" class="paper-texture text-gray-900 w-full max-w-4xl rounded-sm p-2 relative mt-4 mb-8 border-t-8 border-yellow-700 shadow-2xl transition-opacity duration-1000 opacity-0">
        
        <div class="absolute -top-4 left-1/2 transform -translate-x-1/2 w-32 h-8 bg-gray-400 rounded-t-lg opacity-80 shadow-md"></div>

        <div class="border-2 border-gray-400 border-dashed p-4 md:p-6 h-full flex flex-col items-center min-h-[600px]">
            
            <!-- Cabeçalho -->
            <header class="w-full flex flex-col items-center mb-6 border-b-2 border-gray-800 pb-4">
                <img id="game-logo" src="https://github.com/carlossandressantos-cmyk/jogoarquivomorto/blob/main/logo-site.png?raw=true" alt="Arquivo Morto Logo" class="h-24 md:h-32 object-contain mb-2 drop-shadow-sm" onerror="this.style.display='none'; document.getElementById('text-logo').classList.remove('hidden');">
                <div id="text-logo" class="text-center hidden">
                    <h1 class="text-4xl title-font font-bold uppercase tracking-widest text-red-900">Arquivo Morto</h1>
                </div>

                <!-- Menu de Navegação -->
                <div class="flex flex-wrap gap-2 md:gap-4 mt-4 w-full justify-center">
                    <button id="nav-numbers" class="px-4 py-2 bg-gray-300 text-gray-700 text-xs md:text-sm font-bold uppercase tracking-wider border-b-4 border-gray-400 transition-all">
                        1. Evidência Numérica
                    </button>
                    <button id="nav-cards" class="px-4 py-2 bg-gray-300 text-gray-700 text-xs md:text-sm font-bold uppercase tracking-wider border-b-4 border-gray-400 transition-all">
                        2. Cartas
                    </button>
                    <button id="nav-words" class="px-4 py-2 bg-gray-300 text-gray-700 text-xs md:text-sm font-bold uppercase tracking-wider border-b-4 border-gray-400 transition-all">
                        3. Palavras
                    </button>
                </div>
            </header>

            <!-- MODO 1: NÚMEROS -->
            <div id="mode-numbers" class="hidden w-full flex flex-col items-center flex-grow">
                <div id="status-message-num" class="mb-6 h-8 text-center font-bold text-lg text-slate-800">Selecione uma evidência numérica.</div>
                
                <!-- Grid de Seleção -->
                <div id="selection-grid-num" class="grid grid-cols-3 gap-4 mb-8 w-full max-w-md">
                    <!-- Gerado via JS -->
                </div>

                <!-- Oculto -->
                <div id="hidden-screen-num" class="hidden w-full max-w-md h-64 border-4 border-double border-red-900 flex items-center justify-center relative bg-gray-200 mb-8">
                    <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/diagmonds-light.png')]"></div>
                    <div class="stamp-animate border-4 border-red-800 text-red-800 p-2 font-bold text-2xl uppercase tracking-widest title-font opacity-0 transform scale-150 rotate-[-15deg]">Confidencial</div>
                </div>

                <!-- Revelado -->
                <div id="reveal-screen-num" class="hidden w-full max-w-md h-64 flex flex-col items-center justify-center mb-8 relative">
                    <p class="text-sm uppercase tracking-widest mb-2">A evidência selecionada foi:</p>
                    <div class="w-32 h-32 bg-yellow-400 text-black border-4 border-black flex items-center justify-center shadow-lg transform rotate-2">
                        <span id="final-number" class="text-6xl font-bold title-font">?</span>
                    </div>
                    <div class="mt-4 w-full h-4 crime-tape"></div>
                </div>

                <!-- Controles -->
                <div class="flex flex-wrap gap-4 justify-center w-full mt-auto">
                    <button id="btn-hide-num" class="px-6 py-3 bg-gray-800 text-white font-bold tracking-wider hover:bg-gray-700 border-b-4 border-gray-950 active:border-b-0 active:translate-y-1">OCULTAR</button>
                    <button id="btn-reveal-num" class="hidden px-6 py-3 bg-red-800 text-white font-bold tracking-wider hover:bg-red-700 border-b-4 border-red-950 active:border-b-0 active:translate-y-1 animate-pulse">MOSTRAR</button>
                    <button id="btn-reset-num" class="px-6 py-3 bg-yellow-600 text-white font-bold tracking-wider hover:bg-yellow-500 border-b-4 border-yellow-800 active:border-b-0 active:translate-y-1">RESTAURAR</button>
                </div>
            </div>

            <!-- MODO 2: CARTAS -->
            <div id="mode-cards" class="hidden w-full flex flex-col items-center flex-grow perspective-container">
                <div id="status-message-cards" class="mb-4 h-8 text-center font-bold text-lg text-slate-800">Arquivo de Imagens: Solicitar análise.</div>
                <div class="flex-grow flex items-center justify-center w-full mb-6">
                    <div class="relative w-64 h-96 bg-gray-200 border-4 border-gray-800 shadow-2xl rounded-lg p-2 bg-white flex items-center justify-center overflow-hidden">
                        <img id="card-display" src="https://github.com/carlossandressantos-cmyk/jogoarquivomorto/blob/main/verso.png?raw=true" class="w-full h-full object-cover rounded shadow-inner">
                    </div>
                </div>
                <div class="flex flex-wrap gap-4 justify-center w-full mt-auto">
                    <button id="btn-draw-card" class="px-8 py-4 bg-gray-800 text-white font-bold text-xl tracking-widest hover:bg-gray-700 transition-colors border-b-4 border-gray-950 active:border-b-0 active:translate-y-1 shadow-lg">INVESTIGAR ARQUIVO</button>
                </div>
            </div>

            <!-- MODO 3: PALAVRAS -->
            <div id="mode-words" class="hidden w-full flex flex-col items-center flex-grow">
                <div id="status-message-words" class="mb-4 h-8 text-center font-bold text-lg text-slate-800">Selecione exatamente 2 palavras (<span id="count-words">0</span>/2)</div>
                <div id="selection-grid-words" class="w-full max-w-3xl word-list-container overflow-y-auto max-h-[400px] border border-gray-400 p-2 bg-white bg-opacity-50 mb-6">
                    <div id="words-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2"></div>
                </div>
                <div id="reveal-screen-words" class="hidden w-full flex-grow flex flex-col items-center justify-center relative min-h-[300px]">
                    <div class="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                        <span class="text-9xl font-bold text-red-900 rotate-[-30deg]">CONFIDENCIAL</span>
                    </div>
                    <div class="flex flex-col md:flex-row gap-8 items-center justify-center z-10 w-full">
                        <div class="bg-black text-white p-6 border-4 border-red-600 transform -rotate-2 shadow-2xl w-full md:w-5/12 text-center">
                            <span id="final-word-1" class="text-3xl md:text-4xl lg:text-5xl font-bold title-font blinking-text break-words"></span>
                        </div>
                        <div class="text-2xl font-bold text-gray-800">+</div>
                        <div class="bg-black text-white p-6 border-4 border-red-600 transform rotate-2 shadow-2xl w-full md:w-5/12 text-center">
                            <span id="final-word-2" class="text-3xl md:text-4xl lg:text-5xl font-bold title-font blinking-text break-words"></span>
                        </div>
                    </div>
                    <div class="mt-12 w-full h-8 crime-tape"></div>
                </div>
                <div class="flex flex-wrap gap-4 justify-center w-full mt-auto">
                    <button id="btn-reveal-words" class="px-8 py-4 bg-red-900 text-white font-bold text-xl tracking-widest hover:bg-red-800 border-b-4 border-black active:border-b-0 active:translate-y-1 disabled:opacity-40 disabled:cursor-not-allowed">REVELAR SELEÇÃO</button>
                    <button id="btn-reset-words" class="hidden px-6 py-3 bg-yellow-600 text-white font-bold tracking-wider hover:bg-yellow-500 border-b-4 border-yellow-800 active:border-b-0 active:translate-y-1">NOVA SELEÇÃO</button>
                </div>
            </div>

        </div>
        <div class="text-center mt-2 text-xs text-gray-500 font-mono">
            SISTEMA INTEGRADO DE ARQUIVO MORTO v3.1 (Multi-Agente)
        </div>
    </div>

    <!-- Módulo JS (Firebase + Lógica) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === CONFIGURAÇÃO FIREBASE ===
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = __app_id || 'default-app-id';
        
        // CORREÇÃO: Adicionando 'main' ao final para garantir número par de segmentos (6)
        // Caminho: artifacts/{appId}/public/data/gamestate_v1/main
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'gamestate_v1', 'main');

        let currentUser = null;
        let isSpinningLocal = false; // Controle local para animação

        // === ESTADO PADRÃO ===
        const defaultState = {
            mode: 'numbers', // numbers, cards, words
            
            // Números
            numSelected: null,
            numHidden: false,
            numRevealed: false,
            
            // Cartas
            cardSrc: "https://github.com/carlossandressantos-cmyk/jogoarquivomorto/blob/main/verso.png?raw=true",
            cardSpinning: false,
            
            // Palavras
            wordsSelected: [],
            wordsRevealed: false,

            // Metadados
            playersOnline: 0,
            lastUpdate: Date.now()
        };

        // === INICIALIZAÇÃO ===
        async function init() {
            try {
                const userCred = await signInAnonymously(auth);
                currentUser = userCred.user;
                console.log("Conectado como:", currentUser.uid);
                
                document.getElementById('loading-msg').innerText = "Conexão Estabelecida.";
                document.getElementById('btn-start-game').onclick = startGame;

                // Escuta mudanças no Firestore
                onSnapshot(docRef, (snap) => {
                    if (snap.exists()) {
                        updateUI(snap.data());
                    } else {
                        // Se não existe, cria
                        setDoc(docRef, defaultState);
                    }
                });

            } catch (error) {
                console.error("Erro na conexão:", error);
                document.getElementById('loading-msg').innerText = "Erro ao conectar. Tente recarregar.";
            }
        }
        init();

        // === FUNÇÕES DE UI (ATUALIZAÇÃO VISUAL) ===
        function updateUI(state) {
            // Atualiza contador online (fake random + base para sensação de movimento se quiser, ou fixo)
            // Firebase não tem "presence" nativa simples no Firestore sem Realtime DB, 
            // então vamos manter simples ou usar um campo incrementado (complexo para lidar com desconexão).
            // Por simplicidade, assumimos que quem está recebendo updates está online.
            
            // 1. Abas
            switchTabUI(state.mode);

            // 2. Números
            updateNumbersUI(state);

            // 3. Cartas
            updateCardsUI(state);

            // 4. Palavras
            updateWordsUI(state);
        }

        function switchTabUI(mode) {
            ['numbers', 'cards', 'words'].forEach(m => {
                const section = document.getElementById(`mode-${m}`);
                const btn = document.getElementById(`nav-${m}`);
                
                if (m === mode) {
                    section.classList.remove('hidden');
                    btn.classList.remove('bg-gray-300', 'text-gray-700', 'border-gray-400');
                    btn.classList.add('bg-gray-800', 'text-white', 'border-gray-950');
                } else {
                    section.classList.add('hidden');
                    btn.classList.add('bg-gray-300', 'text-gray-700', 'border-gray-400');
                    btn.classList.remove('bg-gray-800', 'text-white', 'border-gray-950');
                }
            });
        }

        function updateNumbersUI(state) {
            const grid = document.getElementById('selection-grid-num');
            const hiddenScreen = document.getElementById('hidden-screen-num');
            const revealScreen = document.getElementById('reveal-screen-num');
            const status = document.getElementById('status-message-num');
            const btnHide = document.getElementById('btn-hide-num');
            const btnReveal = document.getElementById('btn-reveal-num');
            const btnReset = document.getElementById('btn-reset-num');

            // Renderiza Grid se necessário
            if (!grid.innerHTML) {
                for (let i = 1; i <= 6; i++) {
                    const btn = document.createElement('button');
                    btn.className = "evidence-btn-num group relative h-24 bg-gray-200 border-2 border-gray-800 hover:bg-gray-300 transition-all focus:outline-none";
                    btn.innerHTML = `<span class="absolute top-1 left-2 text-xs font-bold text-gray-500">EVIDÊNCIA</span><span class="text-4xl font-bold title-font group-hover:scale-110 transition-transform block">${i}</span>`;
                    btn.onclick = () => updateState({ numSelected: i });
                    grid.appendChild(btn);
                }
            }

            // Atualiza seleção visual
            const buttons = document.querySelectorAll('.evidence-btn-num');
            buttons.forEach((btn, idx) => {
                const num = idx + 1;
                if (num === state.numSelected) {
                    btn.className = "evidence-btn-num group relative h-24 bg-yellow-200 border-2 border-yellow-600 ring-2 ring-yellow-500 transition-all";
                } else {
                    btn.className = "evidence-btn-num group relative h-24 bg-gray-200 border-2 border-gray-800 hover:bg-gray-300 transition-all";
                }
            });

            // Lógica de Telas
            if (state.numRevealed) {
                grid.classList.add('hidden');
                hiddenScreen.classList.add('hidden'); hiddenScreen.classList.remove('flex');
                revealScreen.classList.remove('hidden'); revealScreen.classList.add('flex');
                document.getElementById('final-number').innerText = state.numSelected;
                btnHide.classList.add('hidden');
                btnReveal.classList.add('hidden');
                status.innerText = "CASO REABERTO: Evidência revelada.";
            } else if (state.numHidden) {
                grid.classList.add('hidden');
                hiddenScreen.classList.remove('hidden'); hiddenScreen.classList.add('flex');
                revealScreen.classList.add('hidden'); revealScreen.classList.remove('flex');
                btnHide.classList.add('hidden');
                btnReveal.classList.remove('hidden');
                status.innerText = "Evidência arquivada. Aguardando revelação...";
            } else {
                grid.classList.remove('hidden');
                hiddenScreen.classList.add('hidden'); hiddenScreen.classList.remove('flex');
                revealScreen.classList.add('hidden'); revealScreen.classList.remove('flex');
                btnHide.classList.remove('hidden');
                btnReveal.classList.add('hidden');
                status.innerText = state.numSelected ? `Evidência ${state.numSelected} selecionada.` : "Selecione uma evidência numérica.";
            }
        }

        function updateCardsUI(state) {
            const img = document.getElementById('card-display');
            const btn = document.getElementById('btn-draw-card');
            const status = document.getElementById('status-message-cards');

            // Se o estado diz que está girando, aplica a classe
            if (state.cardSpinning) {
                if (!img.classList.contains('card-spinning')) {
                    img.src = "https://github.com/carlossandressantos-cmyk/jogoarquivomorto/blob/main/verso.png?raw=true";
                    img.classList.add('card-spinning');
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    status.innerText = "Sincronizando banco de dados...";
                }
            } else {
                img.classList.remove('card-spinning');
                if (state.cardSrc && img.src !== state.cardSrc) {
                    img.src = state.cardSrc;
                }
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                
                if (state.cardSrc.includes('verso.png')) {
                    status.innerText = "Arquivo de Imagens: Solicitar análise.";
                    btn.innerText = "INVESTIGAR ARQUIVO";
                } else {
                    status.innerText = "Arquivo recuperado.";
                    btn.innerText = "INVESTIGAR NOVA CARTA";
                }
            }
        }

        function updateWordsUI(state) {
            const container = document.getElementById('words-container');
            
            // Renderiza Grid se vazio
            if (!container.innerHTML) {
                const wordsData = [
                    "Chuva", "Nevoeiro", "Sombra", "Luz", "Ruído", "Silêncio", "Frio", "Calor", "Poeira", "Cinza", "Ecos", "Escuridão", "Reflexo", "Vazio", "Cheiro",
                    "Sangue", "Vidro", "Metal", "Ferrugem", "Papel", "Chave", "Fio", "Relógio", "Espelho", "Máquina", "Faca", "Veneno", "Dinheiro", "Carta", "Telefone",
                    "Verdade", "Mentira", "Segredo", "Culpa", "Inocência", "Tempo", "Passado", "Futuro", "Destino", "Acaso", "Lei", "Caos", "Poder", "Sonho", "Pesadelo",
                    "Medo", "Raiva", "Desejo", "Vingança", "Fuga", "Busca", "Perda", "Espera", "Queda", "Olhar", "Toque", "Grito", "Sussurro", "Solidão", "Loucura",
                    "Vítima", "Assassino", "Testemunha", "Criança", "Velho", "Mulher", "Homem", "Casa", "Rua", "Prisão", "Hospital", "Floresta", "Mar", "Ponte", "Janela",
                    "Início", "Fim", "Sempre", "Nunca", "Talvez", "Antes", "Depois", "Dentro", "Fora", "Alto", "Baixo", "Rápido", "Lento", "Tudo", "Nada"
                ];
                wordsData.forEach(word => {
                    const btn = document.createElement('button');
                    btn.className = 'word-btn text-xs md:text-sm p-2 border border-gray-400 bg-gray-100 hover:bg-yellow-100 font-mono transition-colors truncate';
                    btn.innerText = word;
                    btn.onclick = () => handleWordClick(word, state.wordsSelected);
                    container.appendChild(btn);
                });
            }

            // Atualiza visual
            const buttons = container.querySelectorAll('button');
            buttons.forEach(btn => {
                const word = btn.innerText;
                if (state.wordsSelected.includes(word)) {
                    btn.className = 'word-btn text-xs md:text-sm p-2 bg-yellow-400 border border-black font-bold truncate';
                } else {
                    btn.className = 'word-btn text-xs md:text-sm p-2 border border-gray-400 bg-gray-100 hover:bg-yellow-100 font-mono transition-colors truncate';
                }
            });

            // Atualiza textos
            document.getElementById('count-words').innerText = state.wordsSelected.length;
            const btnReveal = document.getElementById('btn-reveal-words');
            
            if (state.wordsSelected.length === 2) {
                btnReveal.disabled = false;
                btnReveal.classList.remove('opacity-50', 'cursor-not-allowed');
                btnReveal.classList.add('animate-pulse');
            } else {
                btnReveal.disabled = true;
                btnReveal.classList.add('opacity-50', 'cursor-not-allowed');
                btnReveal.classList.remove('animate-pulse');
            }

            // Telas
            const grid = document.getElementById('selection-grid-words');
            const revealScreen = document.getElementById('reveal-screen-words');
            const btnReset = document.getElementById('btn-reset-words');

            if (state.wordsRevealed) {
                grid.classList.add('hidden');
                btnReveal.classList.add('hidden');
                revealScreen.classList.remove('hidden'); revealScreen.classList.add('flex');
                btnReset.classList.remove('hidden');
                
                document.getElementById('final-word-1').innerText = state.wordsSelected[0];
                document.getElementById('final-word-2').innerText = state.wordsSelected[1];
                document.getElementById('status-message-words').innerText = "ASSOCIAÇÃO CONFIRMADA";
            } else {
                grid.classList.remove('hidden');
                btnReveal.classList.remove('hidden');
                revealScreen.classList.add('hidden'); revealScreen.classList.remove('flex');
                btnReset.classList.add('hidden');
                document.getElementById('status-message-words').innerHTML = `Selecione exatamente 2 palavras (<span id="count-words">${state.wordsSelected.length}</span>/2)`;
            }
        }

        // === AÇÕES DE CONTROLE (Envia para Firebase) ===
        
        async function updateState(updates) {
            if (!currentUser) return;
            await updateDoc(docRef, updates);
        }

        // Expondo funções globais para o HTML
        window.startGame = function() {
            // Tenta ativar audio e wake lock
            const audio = document.getElementById('bg-music');
            audio.play().then(() => {
                window.updateAudioIcon(false);
            }).catch(e => console.log(e));
            
            document.getElementById('splash-screen').classList.add('fade-out');
            document.getElementById('main-game-container').classList.remove('opacity-0');
            document.getElementById('main-game-container').classList.add('opacity-100');
            setTimeout(() => document.getElementById('splash-screen').style.display = 'none', 800);
            
            // Wake lock
            if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(e => {});
        };

        // Navegação
        document.getElementById('nav-numbers').onclick = () => updateState({ mode: 'numbers' });
        document.getElementById('nav-cards').onclick = () => updateState({ mode: 'cards' });
        document.getElementById('nav-words').onclick = () => updateState({ mode: 'words' });

        // Números
        document.getElementById('btn-hide-num').onclick = () => updateState({ numHidden: true });
        document.getElementById('btn-reveal-num').onclick = () => updateState({ numRevealed: true });
        document.getElementById('btn-reset-num').onclick = () => updateState({ numSelected: null, numHidden: false, numRevealed: false });

        // Cartas
        window.revealCard = async function() {
            // 1. Inicia giro para todos
            await updateState({ cardSpinning: true });
            
            // 2. Aguarda 3s (Quem clicou controla o sorteio, para não sobrecarregar)
            setTimeout(async () => {
                const randomNum = Math.floor(Math.random() * 60) + 1;
                const newSrc = `https://github.com/carlossandressantos-cmyk/jogoarquivomorto/blob/main/${randomNum}.png?raw=true`;
                
                await updateState({ 
                    cardSpinning: false,
                    cardSrc: newSrc
                });
            }, 3000);
        };

        // Palavras
        window.handleWordClick = async function(word, currentSelected) {
            let newSelected = [...currentSelected];
            if (newSelected.includes(word)) {
                newSelected = newSelected.filter(w => w !== word);
            } else if (newSelected.length < 2) {
                newSelected.push(word);
            }
            await updateState({ wordsSelected: newSelected });
        };
        
        document.getElementById('btn-reveal-words').onclick = () => updateState({ wordsRevealed: true });
        document.getElementById('btn-reset-words').onclick = () => updateState({ wordsSelected: [], wordsRevealed: false });

        // Áudio (Local)
        window.toggleAudio = function() {
            const audio = document.getElementById('bg-music');
            if (audio.paused || audio.muted) {
                audio.muted = false;
                audio.play();
                window.updateAudioIcon(false);
            } else {
                audio.muted = true;
                window.updateAudioIcon(true);
            }
        };

        window.updateAudioIcon = function(isMuted) {
            const on = document.getElementById('icon-sound-on');
            const off = document.getElementById('icon-sound-off');
            if (isMuted) {
                on.classList.add('hidden'); off.classList.remove('hidden');
            } else {
                on.classList.remove('hidden'); off.classList.add('hidden');
            }
        };

    </script>
</body>
</html>
