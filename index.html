<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arquivo Morto - O Jogo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Special+Elite&display=swap" rel="stylesheet">
    <style>
        /* TEMA NOIR / INVESTIGAÃ‡ÃƒO */
        body { font-family: 'Courier Prime', monospace; background-color: #111; color: #eee; overflow-x: hidden; }
        .title-font { font-family: 'Special Elite', cursive; }
        
        /* Textura de Papel */
        .paper-texture {
            background-color: #e3e3e3;
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            color: #1a1a1a;
            box-shadow: 0 0 50px rgba(0,0,0,0.9);
        }

        /* Cartas */
        .card-frame {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .card-frame:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .card-selected {
            border: 4px solid #b91c1c; /* Red border */
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(185, 28, 28, 0.6);
        }
        
        /* BotÃµes e Inputs */
        input:focus { outline: none; border-color: #b91c1c; }
        
        /* AnimaÃ§Ãµes */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        
        .stamp {
            border: 3px solid #b91c1c;
            color: #b91c1c;
            padding: 0.5rem;
            text-transform: uppercase;
            font-weight: bold;
            font-family: 'Special Elite', cursive;
            letter-spacing: 2px;
            transform: rotate(-5deg);
            display: inline-block;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #333; }
        ::-webkit-scrollbar-thumb { background: #666; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 bg-[url('https://github.com/carlossandressantos-cmyk/jogoarquivomorto/blob/main/fundo-site.png?raw=true')] bg-cover bg-fixed bg-center">
    
    <!-- OVERLAY ESCURO PARA LEGIBILIDADE -->
    <div class="fixed inset-0 bg-black/80 z-[-1]"></div>

    <!-- ÃUDIO -->
    <audio id="bg-music" loop>
        <source src="https://files.catbox.moe/tni4fx.mp3" type="audio/mpeg">
    </audio>
    <button onclick="toggleAudio()" class="fixed top-4 right-4 z-50 p-2 bg-black/50 text-white rounded-full border border-gray-600 hover:bg-red-900/50">
        ðŸ”Š/ðŸ”‡
    </button>

    <!-- HEADER -->
    <header class="w-full max-w-5xl flex flex-col items-center mb-4 mt-2">
        <img src="https://github.com/carlossandressantos-cmyk/jogoarquivomorto/blob/main/logo-site.png?raw=true" class="h-24 md:h-32 object-contain drop-shadow-lg mb-2">
        <div class="text-xs text-gray-500 tracking-[0.3em]">DEPARTAMENTO DE CASOS FRIOS</div>
    </header>

    <!-- ÃREA PRINCIPAL DO JOGO -->
    <main id="game-app" class="w-full max-w-5xl min-h-[600px] relative">
        
        <!-- TELA 1: LOGIN -->
        <div id="screen-login" class="paper-texture max-w-md mx-auto p-8 rounded shadow-2xl mt-10 text-center fade-in">
            <h2 class="text-2xl title-font mb-6 border-b-2 border-gray-800 pb-2">IdentificaÃ§Ã£o</h2>
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2 text-left">NOME DO AGENTE:</label>
                <input type="text" id="player-name-input" class="w-full bg-gray-200 border-2 border-gray-400 p-3 font-mono text-lg uppercase" placeholder="Digite seu nome...">
            </div>
            <button onclick="joinGame()" class="w-full bg-gray-900 text-white py-3 font-bold tracking-widest hover:bg-red-900 transition-colors border-2 border-black">
                ENTRAR NO CASO
            </button>
            
            <!-- ÃREA DE ERRO -->
            <div id="connection-status" class="mt-4 p-2 bg-red-100 border border-red-400 text-red-700 text-xs hidden text-left font-mono">
                <strong>STATUS:</strong> <span id="error-details">Conectando...</span>
            </div>
        </div>

        <!-- TELA 2: LOBBY -->
        <div id="screen-lobby" class="hidden paper-texture w-full p-6 rounded shadow-2xl fade-in flex flex-col md:flex-row gap-6">
            <!-- Lista de Jogadores -->
            <div class="flex-1">
                <h2 class="text-2xl title-font mb-4 flex items-center gap-2">
                    <span class="stamp text-sm rotate-0 border-2">AGUARDANDO</span>
                    Agentes na Sala
                </h2>
                <ul id="lobby-player-list" class="space-y-2 font-mono text-lg border-2 border-dashed border-gray-400 p-4 min-h-[200px]">
                    <!-- Lista injetada via JS -->
                    <li class="text-gray-500 italic">Aguardando conexÃ£o...</li>
                </ul>
            </div>
            
            <!-- Controles do Lobby -->
            <div class="w-full md:w-1/3 flex flex-col justify-center border-l-2 border-gray-400 pl-6 border-dashed">
                <div class="bg-yellow-100 p-4 border border-yellow-300 mb-6 text-sm">
                    <strong>INSTRUÃ‡Ã•ES:</strong><br>
                    Aguarde os jogadores (3 a 8).<br>
                    O primeiro a atingir <strong>40 Pontos</strong> vence.<br>
                    Qualquer um pode iniciar.
                </div>
                <button onclick="requestStartGame()" class="w-full bg-red-900 text-white py-4 font-bold text-xl tracking-widest hover:bg-red-800 shadow-lg border-2 border-black">
                    INICIAR MISSÃƒO
                </button>
            </div>
        </div>

        <!-- TELA 3: JOGO (TABULEIRO) -->
        <div id="screen-game" class="hidden w-full flex flex-col gap-4 fade-in">
            
            <!-- BARRA DE STATUS SUPERIOR -->
            <div class="paper-texture p-3 flex justify-between items-center rounded border-b-4 border-red-900">
                <div>
                    <span class="text-xs text-gray-500 block">TESTEMUNHA ATUAL</span>
                    <span id="current-witness-name" class="text-xl font-bold title-font text-red-900">...</span>
                </div>
                <div class="text-center">
                    <span class="text-xs text-gray-500 block">FASE</span>
                    <span id="game-phase-display" class="font-bold bg-black text-white px-3 py-1 text-sm rounded">...</span>
                </div>
                <div class="text-right">
                    <span class="text-xs text-gray-500 block">SEUS PONTOS</span>
                    <span id="my-score" class="text-2xl font-bold title-font">0</span>
                    <span class="text-[10px] text-gray-600">/ 40</span>
                </div>
            </div>

            <!-- ÃREA DE EVIDÃŠNCIAS (PALAVRAS) - VisÃ­vel sempre que houver palavras -->
            <div id="evidence-display" class="hidden paper-texture p-4 text-center border-2 border-gray-800 relative">
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-black text-white px-2 text-xs uppercase tracking-widest">Pistas da Testemunha</div>
                <div class="flex justify-center gap-4 md:gap-8 items-center mt-2">
                    <div id="evidence-1" class="text-xl md:text-3xl font-bold title-font border-b-2 border-red-500">?</div>
                    <div class="text-gray-400 text-lg">&</div>
                    <div id="evidence-2" class="text-xl md:text-3xl font-bold title-font border-b-2 border-red-500">?</div>
                </div>
            </div>

            <!-- ÃREA CENTRAL DE AÃ‡ÃƒO (Muda conforme a fase) -->
            <div id="action-area" class="flex-grow min-h-[400px] flex flex-col relative">
                
                <!-- CONTAINER DE MENSAGENS / WAIT -->
                <div id="msg-container" class="absolute inset-0 flex items-center justify-center bg-black/50 z-20 hidden text-center p-4">
                    <div class="bg-white p-6 rounded shadow-xl max-w-md border-4 border-gray-800">
                        <h3 id="msg-title" class="text-xl font-bold mb-2">Aguarde...</h3>
                        <p id="msg-body" class="text-gray-600">Outros agentes estÃ£o analisando as evidÃªncias.</p>
                        <div class="mt-4 animate-pulse text-red-800 font-mono">ENCRIPTANDO DADOS...</div>
                    </div>
                </div>

                <!-- ÃREA: SELEÃ‡ÃƒO DE CARTAS (MÃ£o do Jogador) -->
                <div id="hand-area" class="hidden">
                    <h3 class="text-white text-center mb-2 text-sm tracking-widest uppercase bg-black/50 p-1">Sua MÃ£o (Selecione <span id="hand-instruction">uma carta</span>)</h3>
                    <div id="my-hand-grid" class="grid grid-cols-3 md:grid-cols-6 gap-2 md:gap-4 p-2 overflow-x-auto">
                        <!-- Cartas geradas via JS -->
                    </div>
                </div>

                <!-- ÃREA: SELEÃ‡ÃƒO DE PALAVRAS (SÃ³ para Testemunha) -->
                <div id="word-selection-area" class="hidden paper-texture p-4 mt-2">
                    <h3 class="text-center font-bold mb-2">SELECIONE 2 PALAVRAS DO ARQUIVO</h3>
                    <div id="word-grid" class="grid grid-cols-3 md:grid-cols-5 gap-2 max-h-[200px] overflow-y-auto p-2 border border-gray-400">
                        <!-- Palavras geradas via JS -->
                    </div>
                    <button onclick="confirmWitnessPlay()" id="btn-confirm-witness" disabled class="w-full mt-4 bg-red-900 text-white py-2 font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                        CONFIRMAR EVIDÃŠNCIAS
                    </button>
                </div>

                <!-- ÃREA: MESA DE VOTAÃ‡ÃƒO (Cartas jogadas) -->
                <div id="voting-table" class="hidden p-4">
                    <h3 class="text-white text-center mb-4 text-xl title-font bg-red-900/80 p-2 rounded">QUEM Ã‰ A TESTEMUNHA? (VOTE)</h3>
                    <div id="table-cards-grid" class="flex flex-wrap justify-center gap-4">
                        <!-- Cartas da mesa -->
                    </div>
                </div>

                <!-- ÃREA: PLACAR (Fim do Round) -->
                <div id="scoring-board" class="hidden paper-texture p-6 m-auto max-w-2xl w-full border-4 border-double border-gray-800">
                    <h2 class="text-3xl title-font text-center mb-6">RELATÃ“RIO DO TURNO</h2>
                    
                    <div id="round-results" class="mb-6 space-y-2 font-mono text-sm border-b border-gray-400 pb-4">
                        <!-- Resultados detalhados -->
                    </div>

                    <h3 class="font-bold mb-2">PLACAR GERAL:</h3>
                    <ul id="scoreboard-list" class="space-y-1 mb-8">
                        <!-- Placar -->
                    </ul>

                    <button onclick="startNextRound()" class="w-full bg-gray-800 text-white py-3 font-bold hover:bg-gray-700">
                        PRÃ“XIMO ARQUIVO >>
                    </button>
                </div>

                <!-- ÃREA: FIM DE JOGO -->
                <div id="game-over-screen" class="hidden paper-texture p-8 m-auto max-w-2xl w-full border-8 border-red-900 shadow-2xl text-center transform rotate-1">
                    <h1 class="text-5xl title-font text-red-900 mb-2">CASO ENCERRADO</h1>
                    <div class="text-xl font-bold mb-8">O ARQUIVO FOI SOLUCIONADO</div>
                    
                    <div class="bg-black text-white p-6 mb-8 rounded shadow-lg">
                        <p class="text-sm uppercase tracking-widest text-gray-400 mb-2">Melhor Investigador</p>
                        <div id="winner-name" class="text-4xl font-bold text-yellow-500 mb-2">AGENTE X</div>
                        <div id="winner-score" class="text-xl">0 Pontos</div>
                    </div>

                    <button onclick="resetGameData()" class="px-8 py-4 bg-red-900 text-white font-bold text-lg hover:bg-red-800 border-2 border-black">
                        NOVO CASO (REINICIAR)
                    </button>
                </div>

            </div>
        </div>

    </main>

    <script type="module">
        // Importando Firebase
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === CONFIGURAÃ‡ÃƒO FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyAbddYCH65EHCTRluFHe4FOE6J5z9yBLxw",
            authDomain: "jogo-arquivo-morto.firebaseapp.com",
            projectId: "jogo-arquivo-morto",
            storageBucket: "jogo-arquivo-morto.firebasestorage.app",
            messagingSenderId: "24019872660",
            appId: "1:24019872660:web:bda2b9dacc0530f48b7d81"
        };

        // === CORREÃ‡ÃƒO: INICIALIZAÃ‡ÃƒO FIREBASE ===
        const APP_NAME = 'ArquivoMorto_Game_V1';
        let app, auth, db;

        try {
            const existingApps = getApps();
            
            // Verifica se jÃ¡ existe um app com o nome especÃ­fico
            const existingApp = existingApps.find(a => a.name === APP_NAME);
            
            if (existingApp) {
                app = existingApp;
                console.log("Firebase reutilizando app existente:", APP_NAME);
            } else {
                app = initializeApp(firebaseConfig, APP_NAME);
                console.log("Firebase inicializado novo app:", APP_NAME);
            }
            
            auth = getAuth(app);
            db = getFirestore(app);
            
        } catch (error) {
            console.error("Erro crÃ­tico ao inicializar Firebase:", error);
            const errBox = document.getElementById('connection-status');
            const errDetails = document.getElementById('error-details');
            if (errBox && errDetails) {
                errBox.classList.remove('hidden');
                errDetails.textContent = "Erro na conexÃ£o com o servidor: " + error.message;
            }
        }

        // Caminho do Jogo
        const GAME_ID = 'sessao_jogo_v4';
        const docRef = doc(db, 'artifacts', 'jogo-arquivo-morto', 'public', 'data', 'gamestate', GAME_ID);

        // VARIÃVEIS LOCAIS
        let myId = null;
        let myName = "";
        let localState = null;
        let selectedWords = [];
        let selectedCard = null;
        let snapshotUnsubscribe = null;

        const TOTAL_CARDS = 60;
        const WINNING_SCORE = 40;
        const WORDS_LIST = [
            "Chuva", "Nevoeiro", "Sombra", "Luz", "RuÃ­do", "SilÃªncio", "Frio", "Calor", "Poeira", "Cinza", "Ecos", "EscuridÃ£o", "Reflexo", "Vazio", "Cheiro",
            "Sangue", "Vidro", "Metal", "Ferrugem", "Papel", "Chave", "Fio", "RelÃ³gio", "Espelho", "MÃ¡quina", "Faca", "Veneno", "Dinheiro", "Carta", "Telefone",
            "Verdade", "Mentira", "Segredo", "Culpa", "InocÃªncia", "Tempo", "Passado", "Futuro", "Destino", "Acaso", "Lei", "Caos", "Poder", "Sonho", "Pesadelo",
            "Medo", "Raiva", "Desejo", "VinganÃ§a", "Fuga", "Busca", "Perda", "Espera", "Queda", "Olhar", "Toque", "Grito", "Sussurro", "SolidÃ£o", "Loucura",
            "VÃ­tima", "Assassino", "Testemunha", "CrianÃ§a", "Velho", "Mulher", "Homem", "Casa", "Rua", "PrisÃ£o", "Hospital", "Floresta", "Mar", "Ponte", "Janela",
            "InÃ­cio", "Fim", "Sempre", "Nunca", "Talvez", "Antes", "Depois", "Dentro", "Fora", "Alto", "Baixo", "RÃ¡pido", "Lento", "Tudo", "Nada"
        ];

        // === INICIALIZAÃ‡ÃƒO ===
        async function init() {
            const errBox = document.getElementById('connection-status');
            const errDetails = document.getElementById('error-details');

            if (!navigator.onLine) {
                if (errBox) {
                    errBox.classList.remove('hidden');
                    errDetails.innerText = "Sem conexÃ£o com a internet.";
                }
                return;
            }

            try {
                // Verificar se Firebase foi inicializado
                if (!app || !auth || !db) {
                    throw new Error("Firebase nÃ£o inicializado");
                }

                // Monitorar estado de autenticaÃ§Ã£o
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        myId = user.uid;
                        console.log("Autenticado como:", myId);
                        
                        // Configurar snapshot listener
                        setupSnapshotListener();
                    } else {
                        console.log("UsuÃ¡rio nÃ£o autenticado");
                    }
                });

                // Tentar login anÃ´nimo
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Erro na inicializaÃ§Ã£o:", error);
                
                if (errBox) {
                    errBox.classList.remove('hidden');
                    let message = error.message;
                    if (message.includes('offline')) {
                        message = "Erro de conexÃ£o. Verifique sua internet.";
                    } else if (message.includes('Firebase')) {
                        message = "Erro no servidor Firebase. Tente recarregar.";
                    }
                    errDetails.innerText = message;
                }
            }
        }

        // Configurar listener do Firestore
        function setupSnapshotListener() {
            // Remove listener anterior se existir
            if (snapshotUnsubscribe) {
                snapshotUnsubscribe();
            }
            
            snapshotUnsubscribe = onSnapshot(docRef, 
                (snap) => {
                    if (snap.exists()) {
                        localState = snap.data();
                        renderGame(localState);
                        
                        // Esconder mensagem de erro se sucesso
                        const errBox = document.getElementById('connection-status');
                        if (errBox) errBox.classList.add('hidden');
                    } else {
                        console.log("Documento nÃ£o existe ainda");
                    }
                },
                (error) => {
                    console.error("Erro no snapshot:", error);
                    
                    const errBox = document.getElementById('connection-status');
                    const errDetails = document.getElementById('error-details');
                    
                    if (errBox) {
                        errBox.classList.remove('hidden');
                        
                        if (error.code === 'failed-precondition') {
                            errDetails.textContent = "PermissÃµes insuficientes. Aguarde configuraÃ§Ã£o.";
                        } else if (error.code === 'unavailable') {
                            errDetails.textContent = "Servidor offline. Tentando reconectar...";
                            // Tentar reconectar apÃ³s 3 segundos
                            setTimeout(setupSnapshotListener, 3000);
                        } else {
                            errDetails.textContent = "Erro de sincronizaÃ§Ã£o: " + error.message;
                        }
                    }
                }
            );
        }

        // Iniciar App
        init();

        // === LÃ“GICA DE LOGIN E LOBBY ===
        window.joinGame = async () => {
            const nameInput = document.getElementById('player-name-input');
            const name = nameInput.value.trim().toUpperCase();
            
            if (!name) {
                alert("Digite um nome para continuar.");
                return;
            }
            
            // Verificar conexÃ£o
            if (!auth.currentUser) {
                alert("Conectando ao servidor... Aguarde um momento.");
                try {
                    await signInAnonymously(auth);
                } catch(e) {
                    alert("Falha na conexÃ£o: " + e.message);
                    return;
                }
            }
            
            myId = auth.currentUser.uid;

            try {
                myName = name;
                
                // Adicionar jogador ao Firestore
                const newPlayer = {
                    id: myId,
                    name: name,
                    score: 0,
                    hand: drawCards(6) // DÃ¡ 6 cartas iniciais
                };

                // Pega estado atual para adicionar player
                const snap = await getDoc(docRef);
                
                if (snap.exists()) {
                    const data = snap.data();
                    
                    // Verifica se jÃ¡ estÃ¡ na lista
                    const existing = data.players ? data.players.find(p => p.id === myId) : null;
                    
                    if (!existing) {
                        const updatedPlayers = data.players ? [...data.players, newPlayer] : [newPlayer];
                        await updateDoc(docRef, { players: updatedPlayers });
                    } else {
                        // Atualiza apenas o nome se jÃ¡ existir
                        const updatedPlayers = data.players.map(p => 
                            p.id === myId ? { ...p, name: name } : p
                        );
                        await updateDoc(docRef, { players: updatedPlayers });
                    }
                } else {
                    // Cria documento se nÃ£o existir
                    await setDoc(docRef, {
                        phase: 'lobby',
                        players: [newPlayer],
                        roundCount: 0,
                        witnessIndex: 0,
                        createdAt: new Date().toISOString()
                    });
                }

                // Atualizar UI
                document.getElementById('screen-login').classList.add('hidden');
                document.getElementById('screen-lobby').classList.remove('hidden');

            } catch (e) {
                console.error("Erro ao entrar:", e);
                
                let msg = e.message;
                if (msg.includes('permission-denied')) {
                    msg = "Erro de permissÃ£o. O jogo pode estar em manutenÃ§Ã£o.";
                } else if (msg.includes('unavailable')) {
                    msg = "Servidor offline. Tente novamente em alguns instantes.";
                }
                
                alert("Erro ao entrar no jogo: " + msg);
            }
        };

        window.requestStartGame = async () => {
            if (!localState || !localState.players || localState.players.length < 3) {
                alert("Ã‰ necessÃ¡rio no mÃ­nimo 3 agentes para iniciar a investigaÃ§Ã£o.");
                return;
            }
            
            try {
                // Configurar Round 1
                await updateDoc(docRef, {
                    phase: 'witness_setup',
                    witnessIndex: 0, // Primeiro jogador Ã© testemunha
                    roundCount: 1,
                    currentWords: [],
                    tableCards: [],
                    votes: {},
                    playedThisRound: []
                });
            } catch (e) {
                console.error("Erro ao iniciar jogo:", e);
                alert("Erro ao iniciar: " + e.message);
            }
        };

        // === RENDERIZAÃ‡ÃƒO PRINCIPAL ===
        function renderGame(state) {
            // Verificar se state Ã© vÃ¡lido
            if (!state) return;
            
            // 1. LOBBY
            if (state.phase === 'lobby') {
                const list = document.getElementById('lobby-player-list');
                
                if (state.players && state.players.length > 0) {
                    list.innerHTML = state.players.map(p => 
                        `<li class="p-2 border-b border-gray-300">
                            <span class="font-bold">ðŸ‘® ${p.name}</span> 
                            ${p.id === myId ? '<span class="text-red-600 text-sm">(VOCÃŠ)</span>' : ''}
                        </li>`
                    ).join('');
                } else {
                    list.innerHTML = '<li class="text-gray-500 italic">Aguardando jogadores...</li>';
                }
                
                // Atualizar UI
                document.getElementById('screen-login').classList.add('hidden');
                document.getElementById('screen-lobby').classList.remove('hidden');
                document.getElementById('screen-game').classList.add('hidden');
                return;
            }

            // Se o jogo comeÃ§ou
            document.getElementById('screen-login').classList.add('hidden');
            document.getElementById('screen-lobby').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');

            // --- HEADER INFO ---
            const witness = state.players && state.players[state.witnessIndex];
            document.getElementById('current-witness-name').innerText = witness ? witness.name : "...";
            
            const me = state.players ? state.players.find(p => p.id === myId) : null;
            if (me) document.getElementById('my-score').innerText = me.score || 0;

            const isWitness = witness && (myId === witness.id);

            // --- FASES DO JOGO ---
            const phaseDisplay = document.getElementById('game-phase-display');
            const handArea = document.getElementById('hand-area');
            const wordArea = document.getElementById('word-selection-area');
            const msgContainer = document.getElementById('msg-container');
            const votingTable = document.getElementById('voting-table');
            const scoringBoard = document.getElementById('scoring-board');
            const evidenceDisplay = document.getElementById('evidence-display');
            const gameOverScreen = document.getElementById('game-over-screen');

            // Reset visibilidade
            handArea.classList.add('hidden');
            wordArea.classList.add('hidden');
            msgContainer.classList.add('hidden');
            votingTable.classList.add('hidden');
            scoringBoard.classList.add('hidden');
            evidenceDisplay.classList.add('hidden');
            gameOverScreen.classList.add('hidden');

            // Atualizar fase
            if (state.phase) {
                const phaseMap = {
                    'witness_setup': 'DEPOIMENTO',
                    'detective_play': 'INVESTIGAÃ‡ÃƒO',
                    'voting': 'VOTAÃ‡ÃƒO',
                    'scoring': 'RELATÃ“RIO',
                    'game_over': 'FIM'
                };
                phaseDisplay.innerText = phaseMap[state.phase] || state.phase;
            }

            // FIM DE JOGO
            if (state.phase === 'game_over') {
                gameOverScreen.classList.remove('hidden');
                
                if (state.winner) {
                    document.getElementById('winner-name').innerText = state.winner.name;
                    document.getElementById('winner-score').innerText = `${state.winner.score} Pontos`;
                }
                return;
            }

            // FASE 1: TESTEMUNHA ESCOLHE
            if (state.phase === 'witness_setup') {
                if (isWitness) {
                    // Testemunha vÃª mÃ£o e palavras
                    handArea.classList.remove('hidden');
                    document.getElementById('hand-instruction').innerText = "A CARTA SECRETA";
                    wordArea.classList.remove('hidden');
                    
                    if (me && me.hand) {
                        renderHand(me.hand, true);
                    }
                    
                    renderWords();
                } else {
                    // Detetives esperam
                    msgContainer.classList.remove('hidden');
                    document.getElementById('msg-title').innerText = "InterrogatÃ³rio em andamento";
                    document.getElementById('msg-body').innerText = witness ? `${witness.name} estÃ¡ analisando os arquivos...` : "Aguardando testemunha...";
                }
            }

            // FASE 2: DETETIVES JOGAM CARTA
            else if (state.phase === 'detective_play') {
                if (state.currentWords && state.currentWords.length >= 2) {
                    evidenceDisplay.classList.remove('hidden');
                    document.getElementById('evidence-1').innerText = state.currentWords[0];
                    document.getElementById('evidence-2').innerText = state.currentWords[1];
                }

                if (isWitness) {
                    msgContainer.classList.remove('hidden');
                    document.getElementById('msg-title').innerText = "Aguardando EvidÃªncias";
                    document.getElementById('msg-body').innerText = "Os detetives estÃ£o escolhendo cartas falsas...";
                } else {
                    // Verifique se eu jÃ¡ joguei
                    const alreadyPlayed = state.playedThisRound && state.playedThisRound.includes(myId);
                    
                    if (alreadyPlayed) {
                        msgContainer.classList.remove('hidden');
                        document.getElementById('msg-title').innerText = "EvidÃªncia Enviada";
                        document.getElementById('msg-body').innerText = "Aguardando os outros detetives.";
                    } else if (me && me.hand) {
                        handArea.classList.remove('hidden');
                        document.getElementById('hand-instruction').innerText = "UMA CARTA PARA CONFUNDIR";
                        renderHand(me.hand, true);
                    }
                }
            }

            // FASE 3: VOTAÃ‡ÃƒO
            else if (state.phase === 'voting') {
                if (state.currentWords && state.currentWords.length >= 2) {
                    evidenceDisplay.classList.remove('hidden');
                    document.getElementById('evidence-1').innerText = state.currentWords[0];
                    document.getElementById('evidence-2').innerText = state.currentWords[1];
                }
                
                votingTable.classList.remove('hidden');
                
                if (state.tableCards && state.tableCards.length > 0) {
                    if (isWitness) {
                        // Testemunha nÃ£o vota, sÃ³ assiste
                        msgContainer.classList.remove('hidden');
                        document.getElementById('msg-title').innerText = "Fase de VotaÃ§Ã£o";
                        document.getElementById('msg-body').innerText = "VocÃª nÃ£o vota neste turno.";
                        renderVotingTable(state.tableCards, false, null);
                    } else {
                        // Detetives votam
                        const myVote = state.votes ? state.votes[myId] : null;
                        if (myVote) {
                            msgContainer.classList.remove('hidden');
                            document.getElementById('msg-title').innerText = "Voto Registrado";
                            document.getElementById('msg-body').innerText = "Aguardando apuraÃ§Ã£o...";
                        } else {
                            // Encontrar minha carta na mesa
                            const myCardId = state.tableCards.find(c => c.owner === myId)?.cardId;
                            renderVotingTable(state.tableCards, true, myCardId);
                        }
                    }
                }
            }

            // FASE 4: PONTUAÃ‡ÃƒO
            else if (state.phase === 'scoring') {
                if (state.currentWords && state.currentWords.length >= 2) {
                    evidenceDisplay.classList.remove('hidden');
                    document.getElementById('evidence-1').innerText = state.currentWords[0];
                    document.getElementById('evidence-2').innerText = state.currentWords[1];
                }
                scoringBoard.classList.remove('hidden');
                renderScoreboard(state);
            }
        }

        // === RENDERIZADORES ===

        function renderHand(cardIds, clickable) {
            const grid = document.getElementById('my-hand-grid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            if (!cardIds || !Array.isArray(cardIds)) {
                grid.innerHTML = '<div class="text-gray-500 italic">Sem cartas disponÃ­veis</div>';
                return;
            }
            
            cardIds.forEach(num => {
                const url = `https://github.com/carlossandressantos-cmyk/jogoarquivomorto/blob/main/${num}.png?raw=true`;
                const div = document.createElement('div');
                div.className = `card-frame rounded overflow-hidden aspect-[2/3] bg-gray-800 border-2 ${selectedCard === num ? 'card-selected' : 'border-gray-600'}`;
                div.innerHTML = `<img src="${url}" class="w-full h-full object-cover" alt="Carta ${num}">`;
                
                if (clickable) {
                    div.onclick = () => {
                        selectedCard = num;
                        renderHand(cardIds, true);
                        
                        if (localState.phase === 'witness_setup') {
                            checkWitnessReady();
                        }
                        if (localState.phase === 'detective_play') {
                            submitDetectiveCard(num);
                        }
                    };
                }
                grid.appendChild(div);
            });
        }

        function renderWords() {
            const grid = document.getElementById('word-grid');
            if (!grid) return;
            
            // Limpar apenas se vazio
            if (grid.children.length > 0) return;

            WORDS_LIST.forEach(word => {
                const btn = document.createElement('button');
                btn.className = "text-xs p-2 bg-gray-200 hover:bg-yellow-200 border border-gray-400 rounded transition-colors";
                btn.innerText = word;
                btn.onclick = () => {
                    if (selectedWords.includes(word)) {
                        selectedWords = selectedWords.filter(w => w !== word);
                        btn.classList.remove('bg-red-800', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-black');
                    } else if (selectedWords.length < 2) {
                        selectedWords.push(word);
                        btn.classList.remove('bg-gray-200', 'text-black');
                        btn.classList.add('bg-red-800', 'text-white');
                    }
                    checkWitnessReady();
                };
                grid.appendChild(btn);
            });
        }

        function checkWitnessReady() {
            const btn = document.getElementById('btn-confirm-witness');
            if (btn) {
                btn.disabled = !(selectedCard && selectedWords.length === 2);
            }
        }

        function renderVotingTable(cards, canVote, myOwnCardId) {
            const grid = document.getElementById('table-cards-grid');
            if (!grid) return;
            
            grid.innerHTML = '';

            if (!cards || !Array.isArray(cards) || cards.length === 0) {
                grid.innerHTML = '<div class="text-gray-500 italic">Nenhuma carta na mesa</div>';
                return;
            }

            cards.forEach(cardObj => {
                const url = `https://github.com/carlossandressantos-cmyk/jogoarquivomorto/blob/main/${cardObj.cardId}.png?raw=true`;
                const div = document.createElement('div');
                
                // Se Ã© a carta do prÃ³prio jogador, nÃ£o pode votar nela
                const isMyCard = cardObj.cardId === myOwnCardId;
                const canClickThis = canVote && !isMyCard;
                
                div.className = `card-frame rounded overflow-hidden w-32 md:w-40 aspect-[2/3] bg-gray-800 border-2 relative ${canClickThis ? 'border-yellow-500 hover:border-red-500' : 'border-gray-600'} ${isMyCard ? 'opacity-50' : ''}`;
                div.innerHTML = `
                    <img src="${url}" class="w-full h-full object-cover" alt="Carta ${cardObj.cardId}">
                    ${isMyCard ? '<div class="absolute bottom-0 w-full bg-red-900 text-white text-xs text-center py-1">SUA CARTA</div>' : ''}
                `;
                
                if (canClickThis) {
                    div.onclick = async () => {
                        if (confirm(`Votar nesta carta como sendo da TESTEMUNHA?`)) {
                            try {
                                // Registra voto
                                const currentVotes = localState.votes || {};
                                currentVotes[myId] = cardObj.owner;
                                
                                await updateDoc(docRef, {
                                    votes: currentVotes
                                });
                                
                                // Verificar se todos votaram
                                checkIfAllVoted();
                            } catch (e) {
                                console.error("Erro ao votar:", e);
                                alert("Erro ao registrar voto: " + e.message);
                            }
                        }
                    };
                }
                
                grid.appendChild(div);
            });
        }

        async function checkIfAllVoted() {
            if (!localState || !localState.players || !localState.votes) return;
            
            // Testemunha nÃ£o vota
            const witness = localState.players[localState.witnessIndex];
            const detectivesCount = localState.players.length - 1;
            const votesCount = Object.keys(localState.votes).length;
            
            if (votesCount >= detectivesCount) {
                // Todos votaram, calcular pontuaÃ§Ã£o
                await calculateScores();
            }
        }

        async function calculateScores() {
            if (!localState || !localState.players || !localState.votes) return;
            
            try {
                const witness = localState.players[localState.witnessIndex];
                const votes = localState.votes;
                
                // Contar votos
                const voteCounts = {};
                Object.values(votes).forEach(votedId => {
                    voteCounts[votedId] = (voteCounts[votedId] || 0) + 1;
                });
                
                // Calcular pontos
                const updatedPlayers = localState.players.map(p => {
                    let points = 0;
                    
                    if (p.id === witness.id) {
                        // Testemunha ganha pontos pelos votos que recebeu
                        points = voteCounts[p.id] || 0;
                    } else {
                        // Detetives ganham pontos se votaram corretamente
                        if (votes[p.id] === witness.id) {
                            points = 3;
                        }
                    }
                    
                    return {
                        ...p,
                        score: (p.score || 0) + points
                    };
                });
                
                // Verificar se alguÃ©m ganhou
                const winner = updatedPlayers.find(p => p.score >= WINNING_SCORE);
                
                if (winner) {
                    await updateDoc(docRef, {
                        phase: 'game_over',
                        players: updatedPlayers,
                        winner: winner
                    });
                } else {
                    await updateDoc(docRef, {
                        phase: 'scoring',
                        players: updatedPlayers
                    });
                }
            } catch (e) {
                console.error("Erro ao calcular pontos:", e);
            }
        }

        function renderScoreboard(state) {
            const resultsDiv = document.getElementById('round-results');
            const scoreList = document.getElementById('scoreboard-list');
            
            if (!state || !state.players) return;
            
            // Resultados do turno
            const witness = state.players[state.witnessIndex];
            resultsDiv.innerHTML = `
                <div class="bg-yellow-100 p-3 border border-yellow-400 mb-2">
                    <strong>TESTEMUNHA:</strong> ${witness ? witness.name : 'Desconhecido'}
                </div>
                <div class="text-sm">
                    <strong>PALAVRAS ESCOLHIDAS:</strong> 
                    ${state.currentWords ? state.currentWords.join(' & ') : 'N/A'}
                </div>
            `;
            
            // Placar geral
            const sortedPlayers = [...state.players].sort((a, b) => (b.score || 0) - (a.score || 0));
            scoreList.innerHTML = sortedPlayers.map(p => `
                <li class="flex justify-between p-2 border-b border-gray-300 ${p.id === myId ? 'bg-yellow-100 font-bold' : ''}">
                    <span>ðŸ‘® ${p.name}</span>
                    <span class="font-mono">${p.score || 0} pts</span>
                </li>
            `).join('');
        }

        window.confirmWitnessPlay = async () => {
            if (!selectedCard || selectedWords.length !== 2) {
                alert("Selecione 1 carta e 2 palavras.");
                return;
            }
            
            try {
                // Adicionar carta da testemunha Ã  mesa
                const tableCards = [{
                    cardId: selectedCard,
                    owner: myId
                }];
                
                // Remover carta da mÃ£o
                const me = localState.players.find(p => p.id === myId);
                if (me && me.hand) {
                    const newHand = me.hand.filter(c => c !== selectedCard);
                    
                    const updatedPlayers = localState.players.map(p => 
                        p.id === myId ? { ...p, hand: newHand } : p
                    );
                    
                    await updateDoc(docRef, {
                        phase: 'detective_play',
                        currentWords: selectedWords,
                        tableCards: tableCards,
                        playedThisRound: [myId],
                        players: updatedPlayers
                    });
                    
                    // Reset seleÃ§Ãµes
                    selectedCard = null;
                    selectedWords = [];
                }
            } catch (e) {
                console.error("Erro ao confirmar jogada:", e);
                alert("Erro ao enviar: " + e.message);
            }
        };

        async function submitDetectiveCard(cardId) {
            if (!localState || localState.phase !== 'detective_play') return;
            
            try {
                // Verificar se jÃ¡ jogou
                if (localState.playedThisRound && localState.playedThisRound.includes(myId)) {
                    return;
                }
                
                // Adicionar carta Ã  mesa
                const newTableCard = {
                    cardId: cardId,
                    owner: myId
                };
                
                const updatedTableCards = [...(localState.tableCards || []), newTableCard];
                const updatedPlayedList = [...(localState.playedThisRound || []), myId];
                
                // Remover carta da mÃ£o
                const me = localState.players.find(p => p.id === myId);
                if (me && me.hand) {
                    const newHand = me.hand.filter(c => c !== cardId);
                    
                    const updatedPlayers = localState.players.map(p => 
                        p.id === myId ? { ...p, hand: newHand } : p
                    );
                    
                    await updateDoc(docRef, {
                        tableCards: updatedTableCards,
                        playedThisRound: updatedPlayedList,
                        players: updatedPlayers
                    });
                    
                    selectedCard = null;
                    
                    // Verificar se todos jogaram
                    checkIfAllPlayedCards(updatedPlayedList);
                }
            } catch (e) {
                console.error("Erro ao jogar carta:", e);
                alert("Erro ao enviar carta: " + e.message);
            }
        }

        async function checkIfAllPlayedCards(playedList) {
            if (!localState || !localState.players) return;
            
            // Todos menos a testemunha + a testemunha = todos
            if (playedList.length >= localState.players.length) {
                // Embaralhar cartas da mesa
                const shuffled = [...localState.tableCards].sort(() => Math.random() - 0.5);
                
                await updateDoc(docRef, {
                    phase: 'voting',
                    tableCards: shuffled,
                    votes: {}
                });
            }
        }

        window.startNextRound = async () => {
            if (!localState || !localState.players) return;
            
            try {
                // PrÃ³xima testemunha
                const nextWitnessIndex = (localState.witnessIndex + 1) % localState.players.length;
                
                // Dar novas cartas para quem precisa
                const updatedPlayers = localState.players.map(p => {
                    if (p.hand && p.hand.length < 6) {
                        const needed = 6 - p.hand.length;
                        const newCards = drawCards(needed);
                        return { ...p, hand: [...p.hand, ...newCards] };
                    }
                    return p;
                });
                
                await updateDoc(docRef, {
                    phase: 'witness_setup',
                    witnessIndex: nextWitnessIndex,
                    roundCount: (localState.roundCount || 0) + 1,
                    currentWords: [],
                    tableCards: [],
                    votes: {},
                    playedThisRound: [],
                    players: updatedPlayers
                });
            } catch (e) {
                console.error("Erro ao iniciar novo round:", e);
                alert("Erro: " + e.message);
            }
        };

        window.resetGameData = async () => {
            if (!confirm("Reiniciar o jogo? Todos os dados serÃ£o perdidos.")) return;
            
            try {
                await updateDoc(docRef, {
                    phase: 'lobby',
                    players: [],
                    roundCount: 0,
                    witnessIndex: 0,
                    currentWords: [],
                    tableCards: [],
                    votes: {},
                    playedThisRound: [],
                    winner: null
                });
                
                // Recarregar pÃ¡gina
                location.reload();
            } catch (e) {
                console.error("Erro ao resetar:", e);
                alert("Erro ao reiniciar: " + e.message);
            }
        };

        window.toggleAudio = () => {
            const audio = document.getElementById('bg-music');
            if (audio.paused) {
                audio.play();
            } else {
                audio.pause();
            }
        };

        // === FUNÃ‡ÃƒO AUXILIAR: SORTEAR CARTAS ===
        function drawCards(count) {
            const cards = [];
            for (let i = 0; i < count; i++) {
                const randomCard = Math.floor(Math.random() * TOTAL_CARDS) + 1;
                cards.push(randomCard);
            }
            return cards;
        }

    </script>
</body>
</html>
