<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arquivo Morto - O Jogo (DEV MODE)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Special+Elite&display=swap" rel="stylesheet">
    <style>
        /* TEMA NOIR / INVESTIGA√á√ÉO */
        body { font-family: 'Courier Prime', monospace; background-color: #111; color: #eee; overflow-x: hidden; }
        .title-font { font-family: 'Special Elite', cursive; }
        
        /* Textura de Papel */
        .paper-texture {
            background-color: #e3e3e3;
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            color: #1a1a1a;
            box-shadow: 0 0 50px rgba(0,0,0,0.9);
        }

        /* Cartas */
        .card-frame {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .card-frame:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .card-selected {
            border: 4px solid #b91c1c; /* Red border */
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(185, 28, 28, 0.6);
        }
        
        /* Bot√µes e Inputs */
        input:focus { outline: none; border-color: #b91c1c; }
        
        /* Anima√ß√µes */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #333; }
        ::-webkit-scrollbar-thumb { background: #666; border-radius: 4px; }

        /* Modal de Regras */
        .marker-highlight {
            background: linear-gradient(120deg, #f6e05e88 0%, #f6e05e88 100%);
            background-repeat: no-repeat;
            background-size: 100% 40%;
            background-position: 0 80%;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 bg-[url('https://github.com/carlossandressantos-cmyk/jogoarquivomorto/blob/main/fundo-site.png?raw=true')] bg-cover bg-fixed bg-center">
    
    <!-- OVERLAY ESCURO -->
    <div class="fixed inset-0 bg-black/80 z-[-1]"></div>

    <!-- √ÅUDIO -->
    <audio id="bg-music" loop>
        <source src="https://files.catbox.moe/tni4fx.mp3" type="audio/mpeg">
    </audio>
    <button onclick="toggleAudio()" class="fixed top-4 right-4 z-50 p-2 bg-black/50 text-white rounded-full border border-gray-600 hover:bg-red-900/50">
        üîä/üîá
    </button>

    <!-- HEADER -->
    <header class="w-full max-w-5xl flex flex-col items-center mb-4 mt-2">
        <img src="https://github.com/carlossandressantos-cmyk/jogoarquivomorto/blob/main/logo-site.png?raw=true" class="h-24 md:h-32 object-contain drop-shadow-lg mb-2">
        <div class="text-xs text-gray-500 tracking-[0.3em]">DEPARTAMENTO DE CASOS FRIOS</div>
    </header>

    <!-- √ÅREA PRINCIPAL DO JOGO -->
    <main id="game-app" class="w-full max-w-5xl min-h-[600px] relative">
        
        <!-- MODAL: MANUAL DE REGRAS (NOVO) -->
        <div id="rules-modal" class="hidden fixed inset-0 bg-black/95 z-[60] overflow-y-auto p-4 flex items-center justify-center fade-in">
            <div class="bg-white max-w-3xl w-full p-8 rounded paper-texture relative border-4 border-gray-800 shadow-2xl">
                <button onclick="hideRules()" class="absolute top-4 right-4 text-2xl font-bold hover:text-red-600">X</button>
                
                <h2 class="text-3xl title-font text-center mb-6 text-red-900 border-b-2 border-gray-800 pb-2">MANUAL DE PROTOCOLO</h2>
                
                <div class="space-y-6 text-gray-900 overflow-y-auto max-h-[70vh] pr-2 text-sm md:text-base leading-relaxed">
                    
                    <div>
                        <h3 class="font-bold text-lg bg-gray-300 inline-block px-2 mb-2">1. O OBJETIVO</h3>
                        <p>Desvendar a imagem correta baseada nas pistas vagas deixadas pela Testemunha. O primeiro investigador a atingir <strong class="marker-highlight">25 Pontos</strong> encerra o caso e vence.</p>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="bg-gray-100 p-3 border border-gray-400">
                            <h4 class="font-bold text-red-900">üëÅÔ∏è A TESTEMUNHA (1 Jogador)</h4>
                            <p class="text-xs mt-1">Sabe a verdade. Deve dar pistas que n√£o sejam nem muito f√°ceis (todos acertam), nem muito dif√≠ceis (ningu√©m acerta).</p>
                        </div>
                        <div class="bg-gray-100 p-3 border border-gray-400">
                            <h4 class="font-bold text-blue-900">üïµÔ∏è OS DETETIVES (Outros)</h4>
                            <p class="text-xs mt-1">Devem encontrar a carta da Testemunha e jogar cartas falsas para confundir os rivais.</p>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-bold text-lg bg-gray-300 inline-block px-2 mb-2">2. COMO JOGAR (O FLUXO)</h3>
                        <ul class="list-decimal list-inside space-y-3">
                            <li><strong>FASE 1: O Depoimento (Testemunha)</strong><br>
                                A Testemunha escolhe secretamente uma carta de sua m√£o e seleciona <span class="font-bold">2 Palavras</span> (Pistas) que descrevam essa imagem.
                            </li>
                            <li><strong>FASE 2: A Investiga√ß√£o (Detetives)</strong><br>
                                Os Detetives veem as 2 palavras. Eles devem escolher de sua pr√≥pria m√£o uma carta que <span class="italic">tamb√©m combine</span> com essas palavras para enganar os outros.
                            </li>
                            <li><strong>FASE 3: O Veredito (Vota√ß√£o)</strong><br>
                                Todas as cartas (da Testemunha e dos Detetives) s√£o embaralhadas e reveladas na mesa. Os Detetives devem votar em qual carta acham que √© a da Testemunha. <em class="text-xs text-red-600">(Voc√™ n√£o pode votar na sua pr√≥pria carta).</em>
                            </li>
                        </ul>
                    </div>

                    <div>
                        <h3 class="font-bold text-lg bg-gray-300 inline-block px-2 mb-2">3. PONTUA√á√ÉO (O RELAT√ìRIO)</h3>
                        <ul class="space-y-2 text-sm border-l-4 border-gray-800 pl-4">
                            <li>‚úÖ <strong>Se o Detetive acertar a carta da Testemunha:</strong> Ganha <span class="marker-highlight font-bold">+3 Pontos</span>.</li>
                            <li>üé≠ <strong>Se um Detetive enganar outro (algu√©m vota na carta falsa dele):</strong> O dono da carta falsa ganha <span class="font-bold">+1 Ponto</span> por voto recebido.</li>
                            <li>‚öñÔ∏è <strong>A Testemunha Pontua se:</strong> Pelo menos um (mas n√£o todos) acertar sua carta. Ela ganha <span class="font-bold">+3 Pontos</span>.</li>
                            <li>‚ùå <strong>A Testemunha perde (0 pts) se:</strong> TODOS acertarem (foi √≥bvio demais) ou NINGU√âM acertar (foi dif√≠cil demais). Nesse caso, todos os detetives ganham +2 pontos extras (B√¥nus de Incompet√™ncia).</li>
                        </ul>
                    </div>
                </div>

                <div class="mt-6 text-center">
                    <button onclick="hideRules()" class="bg-red-900 text-white px-8 py-3 font-bold border-2 border-black hover:bg-red-800">ENTENDIDO, AGENTE.</button>
                </div>
            </div>
        </div>

        <!-- TELA 1: LOGIN E SELE√á√ÉO DE SALA -->
        <div id="screen-login" class="paper-texture max-w-md mx-auto p-8 rounded shadow-2xl mt-10 text-center fade-in">
            <h2 class="text-2xl title-font mb-6 border-b-2 border-gray-800 pb-2">Identifica√ß√£o</h2>
            
            <!-- Aviso de Protocolo Local -->
            <div id="file-protocol-warning" class="hidden mb-4 p-3 bg-red-100 border-l-4 border-red-600 text-red-900 text-xs text-left">
                <strong>‚ö†Ô∏è MODO OFFLINE DETECTADO:</strong> Voc√™ abriu o arquivo direto. Navegadores bloqueiam conex√µes assim.<br>
                <span class="block mt-1">Solu√ß√£o: Use a extens√£o <strong>"Live Server"</strong> no VS Code ou hospede no Vercel/GitHub Pages.</span>
            </div>

            <!-- Aviso de Configura√ß√£o Faltante (JavaScript vai ativar se necess√°rio) -->
            <div id="config-warning" class="hidden mb-4 p-3 bg-yellow-100 border-l-4 border-yellow-600 text-yellow-900 text-xs text-left font-mono">
                <strong>ATEN√á√ÉO:</strong> As chaves do Firebase parecem ser as de exemplo.<br>
                Para jogar online com amigos, voc√™ precisa criar seu pr√≥prio projeto no <a href="https://console.firebase.google.com" target="_blank" class="underline font-bold">Firebase Console</a> e colar as chaves no c√≥digo.
            </div>

            <!-- Nome -->
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2 text-left">NOME DO AGENTE:</label>
                <input type="text" id="player-name-input" class="w-full bg-gray-200 border-2 border-gray-400 p-3 font-mono text-lg uppercase" placeholder="SEU NOME">
            </div>

            <!-- Sala -->
            <div class="mb-6">
                <label class="block text-sm font-bold mb-2 text-left">C√ìDIGO DO ARQUIVO (SALA):</label>
                <div class="flex gap-2">
                    <input type="text" id="room-code-input" class="w-2/3 bg-gray-200 border-2 border-gray-400 p-3 font-mono text-lg uppercase tracking-widest" placeholder="EX: A1B2" maxlength="4">
                    <button onclick="generateRoomCode()" class="w-1/3 bg-gray-800 text-white text-xs p-2 hover:bg-gray-700">GERAR NOVO</button>
                </div>
            </div>

            <button onclick="joinGame()" class="w-full bg-red-900 text-white py-3 font-bold tracking-widest hover:bg-red-800 transition-colors border-2 border-black mb-3">
                ACESSAR ARQUIVO
            </button>

            <!-- Bot√£o Manual no Login -->
            <button onclick="showRules()" class="w-full bg-gray-700 text-white py-2 text-xs font-bold tracking-widest hover:bg-gray-600 border border-gray-500">
                üìñ COMO JOGAR
            </button>
            
            <div id="connection-status" class="mt-4 p-2 bg-yellow-100 border border-yellow-400 text-yellow-800 text-xs hidden text-left font-mono">
                <strong>STATUS:</strong> <span id="error-details">Conectando...</span>
            </div>
        </div>

        <!-- TELA 2: LOBBY -->
        <div id="screen-lobby" class="hidden paper-texture w-full p-6 rounded shadow-2xl fade-in flex flex-col md:flex-row gap-6">
            <!-- Lista de Jogadores -->
            <div class="flex-1">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-2xl title-font flex items-center gap-2">
                        <span class="stamp text-sm rotate-0 border-2">SALA: <span id="lobby-room-code">----</span></span>
                    </h2>
                    <div class="text-xs text-gray-500 max-w-[150px] text-right">Compartilhe este c√≥digo com seus amigos</div>
                </div>
                
                <h3 class="font-bold mb-2">AGENTES CONECTADOS:</h3>
                <ul id="lobby-player-list" class="space-y-2 font-mono text-lg border-2 border-dashed border-gray-400 p-4 min-h-[200px]">
                    <li class="text-gray-500 italic">Aguardando conex√£o...</li>
                </ul>
            </div>
            
            <!-- Controles do Lobby -->
            <div class="w-full md:w-1/3 flex flex-col justify-center border-l-2 border-gray-400 pl-6 border-dashed">
                <div class="bg-yellow-100 p-4 border border-yellow-300 mb-6 text-sm">
                    <strong>INSTRU√á√ïES:</strong><br>
                    M√≠nimo: 1 Agente.<br>
                    Objetivo: 25 Pontos.<br>
                </div>
                
                <button onclick="showRules()" class="w-full mb-3 bg-gray-700 text-white py-3 font-bold hover:bg-gray-600 border-2 border-gray-900">
                    MANUAL DO AGENTE
                </button>

                <button onclick="requestStartGame()" class="w-full bg-red-900 text-white py-4 font-bold text-xl tracking-widest hover:bg-red-800 shadow-lg border-2 border-black">
                    INICIAR MISS√ÉO
                </button>
            </div>
        </div>

        <!-- TELA 3: JOGO (TABULEIRO) -->
        <div id="screen-game" class="hidden w-full flex flex-col gap-4 fade-in">
            
            <!-- BARRA DE STATUS SUPERIOR -->
            <div class="paper-texture p-3 flex justify-between items-center rounded border-b-4 border-red-900">
                <div>
                    <span class="text-xs text-gray-500 block">TESTEMUNHA ATUAL</span>
                    <span id="current-witness-name" class="text-xl font-bold title-font text-red-900">...</span>
                </div>
                <div class="text-center">
                    <span class="text-xs text-gray-500 block">FASE</span>
                    <span id="game-phase-display" class="font-bold bg-black text-white px-3 py-1 text-sm rounded">...</span>
                </div>
                <div class="text-right">
                    <span class="text-xs text-gray-500 block">SEUS PONTOS</span>
                    <span id="my-score" class="text-2xl font-bold title-font">0</span>
                    <span class="text-[10px] text-gray-600">/ 25</span>
                </div>
            </div>

            <!-- √ÅREA DE EVID√äNCIAS -->
            <div id="evidence-display" class="hidden paper-texture p-4 text-center border-2 border-gray-800 relative">
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-black text-white px-2 text-xs uppercase tracking-widest">Pistas da Testemunha</div>
                <div class="flex justify-center gap-4 md:gap-8 items-center mt-2">
                    <div id="evidence-1" class="text-xl md:text-3xl font-bold title-font border-b-2 border-red-500">?</div>
                    <div class="text-gray-400 text-lg">&</div>
                    <div id="evidence-2" class="text-xl md:text-3xl font-bold title-font border-b-2 border-red-500">?</div>
                </div>
            </div>

            <!-- √ÅREA CENTRAL DE A√á√ÉO -->
            <div id="action-area" class="flex-grow min-h-[400px] flex flex-col relative">
                
                <!-- CONTAINER DE MENSAGENS / WAIT -->
                <div id="msg-container" class="absolute inset-0 flex items-center justify-center bg-black/50 z-20 hidden text-center p-4">
                    <div class="bg-white p-6 rounded shadow-xl max-w-md border-4 border-gray-800">
                        <h3 id="msg-title" class="text-xl font-bold mb-2">Aguarde...</h3>
                        <p id="msg-body" class="text-gray-600">Outros agentes est√£o analisando as evid√™ncias.</p>
                        <div class="mt-4 animate-pulse text-red-800 font-mono">ENCRIPTANDO DADOS...</div>
                    </div>
                </div>

                <!-- √ÅREA: SELE√á√ÉO DE CARTAS (M√£o do Jogador) -->
                <div id="hand-area" class="hidden">
                    <h3 class="text-white text-center mb-2 text-sm tracking-widest uppercase bg-black/50 p-1">Sua M√£o (Selecione <span id="hand-instruction">uma carta</span>)</h3>
                    <div id="my-hand-grid" class="grid grid-cols-3 md:grid-cols-6 gap-2 md:gap-4 p-2 overflow-x-auto">
                        <!-- Cartas geradas via JS -->
                    </div>
                </div>

                <!-- √ÅREA: SELE√á√ÉO DE PALAVRAS (S√≥ para Testemunha) -->
                <div id="word-selection-area" class="hidden paper-texture p-4 mt-2">
                    <h3 class="text-center font-bold mb-2">SELECIONE 2 PALAVRAS DO ARQUIVO</h3>
                    <div id="word-grid" class="grid grid-cols-3 md:grid-cols-5 gap-2 max-h-[200px] overflow-y-auto p-2 border border-gray-400">
                        <!-- Palavras geradas via JS -->
                    </div>
                    <button onclick="confirmWitnessPlay()" id="btn-confirm-witness" disabled class="w-full mt-4 bg-red-900 text-white py-2 font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                        CONFIRMAR EVID√äNCIAS
                    </button>
                </div>

                <!-- √ÅREA: MESA DE VOTA√á√ÉO -->
                <div id="voting-table" class="hidden p-4">
                    <h3 class="text-white text-center mb-4 text-xl title-font bg-red-900/80 p-2 rounded">QUEM √â A TESTEMUNHA? (VOTE)</h3>
                    <div id="table-cards-grid" class="flex flex-wrap justify-center gap-4">
                        <!-- Cartas da mesa -->
                    </div>
                </div>

                <!-- √ÅREA: PLACAR -->
                <div id="scoring-board" class="hidden paper-texture p-6 m-auto max-w-2xl w-full border-4 border-double border-gray-800">
                    <h2 class="text-3xl title-font text-center mb-6">RELAT√ìRIO DO TURNO</h2>
                    
                    <div id="round-results" class="mb-6 space-y-2 font-mono text-sm border-b border-gray-400 pb-4">
                        <!-- Resultados detalhados -->
                    </div>

                    <h3 class="font-bold mb-2">PLACAR GERAL:</h3>
                    <ul id="scoreboard-list" class="space-y-1 mb-8">
                        <!-- Placar -->
                    </ul>

                    <button onclick="startNextRound()" class="w-full bg-gray-800 text-white py-3 font-bold hover:bg-gray-700">
                        PR√ìXIMO ARQUIVO >>
                    </button>
                </div>

                <!-- √ÅREA: FIM DE JOGO -->
                <div id="game-over-screen" class="hidden paper-texture p-8 m-auto max-w-2xl w-full border-8 border-red-900 shadow-2xl text-center transform rotate-1">
                    <h1 class="text-5xl title-font text-red-900 mb-2">CASO ENCERRADO</h1>
                    <div class="text-xl font-bold mb-8">O ARQUIVO FOI SOLUCIONADO</div>
                    
                    <div class="bg-black text-white p-6 mb-8 rounded shadow-lg">
                        <p class="text-sm uppercase tracking-widest text-gray-400 mb-2">Melhor Investigador</p>
                        <div id="winner-name" class="text-4xl font-bold text-yellow-500 mb-2">AGENTE X</div>
                        <div id="winner-score" class="text-xl">0 Pontos</div>
                    </div>

                    <button onclick="resetGameData()" class="px-8 py-4 bg-red-900 text-white font-bold text-lg hover:bg-red-800 border-2 border-black">
                        NOVO CASO (REINICIAR)
                    </button>
                </div>

            </div>
        </div>

    </main>

    <!-- M√≥dulo JS -->
    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, getDoc, initializeFirestore, memoryLocalCache } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // === CONFIGURA√á√ÉO FIREBASE ===
        // ----------------------------------------------------------------------------------
        // ATEN√á√ÉO: PARA O JOGO FUNCIONAR ONLINE (MULTIPLAYER ENTRE AMIGOS),
        // VOC√ä PRECISA CRIAR UM PROJETO NO FIREBASE E COLAR SUAS CHAVES AQUI EMBAIXO.
        // ----------------------------------------------------------------------------------
        
        const firebaseConfig = {
            apiKey: "AIza" + "SyBcxWA_okoi5ywIThSmqX4VDWdJ59KXHDg",
            authDomain: "meu-arquivo-morto.firebaseapp.com",
            projectId: "meu-arquivo-morto",
            storageBucket: "meu-arquivo-morto.firebasestorage.app",
            messagingSenderId: "786003168874",
            appId: "1:786003168874:web:273c793ba59df0c0818413"
        };
        
        // Verifica se ainda est√° com a config de exemplo e avisa na tela
        if (firebaseConfig.projectId === "jogo-arquivo-morto") {
            document.getElementById('config-warning').classList.remove('hidden');
        }

        // Verifica protocolo file:// e avisa
        if (window.location.protocol === 'file:') {
            document.getElementById('file-protocol-warning').classList.remove('hidden');
        }

        // === INICIALIZA√á√ÉO ===
        // Verifica se j√° existe um app inicializado para evitar erros de duplicidade
        const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApp();
        const auth = getAuth(app);
        
        let db;
        try {
            // Tenta inicializar com persist√™ncia simples
            db = initializeFirestore(app, { localCache: memoryLocalCache() });
            console.log("Sistema online");
        } catch (e) {
            // Se falhar (ex: app j√° inicializado), pega a inst√¢ncia existente
            db = getFirestore(app);
        }

        // Vari√°veis
        let currentRoomId = null;
        let docRef = null;
        let myId = null;
        let myName = "";
        let localState = null;
        let selectedWords = [];
        let selectedCard = null;
        let unsubscribeRoom = null;
        let joinAttempts = 0;

        const TOTAL_CARDS = 60;
        const WINNING_SCORE = 25; // ALTERA√á√ÉO 1: Meta reduzida para 25 pontos
        const WORDS_LIST = [
            "Chuva", "Nevoeiro", "Sombra", "Luz", "Ru√≠do", "Sil√™ncio", "Frio", "Calor", "Poeira", "Cinza", "Ecos", "Escurid√£o", "Reflexo", "Vazio", "Cheiro",
            "Sangue", "Vidro", "Metal", "Ferrugem", "Papel", "Chave", "Fio", "Rel√≥gio", "Espelho", "M√°quina", "Faca", "Veneno", "Dinheiro", "Carta", "Telefone",
            "Verdade", "Mentira", "Segredo", "Culpa", "Inoc√™ncia", "Tempo", "Passado", "Futuro", "Destino", "Acaso", "Lei", "Caos", "Poder", "Sonho", "Pesadelo",
            "Medo", "Raiva", "Desejo", "Vingan√ßa", "Fuga", "Busca", "Perda", "Espera", "Queda", "Olhar", "Toque", "Grito", "Sussurro", "Solid√£o", "Loucura",
            "V√≠tima", "Assassino", "Testemunha", "Crian√ßa", "Velho", "Mulher", "Homem", "Casa", "Rua", "Pris√£o", "Hospital", "Floresta", "Mar", "Ponte", "Janela",
            "In√≠cio", "Fim", "Sempre", "Nunca", "Talvez", "Antes", "Depois", "Dentro", "Fora", "Alto", "Baixo", "R√°pido", "Lento", "Tudo", "Nada"
        ];

        window.generateRoomCode = () => {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let code = "";
            for(let i=0; i<4; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
            document.getElementById('room-code-input').value = code;
        }

        // Fun√ß√µes do Modal de Regras
        window.showRules = () => {
            document.getElementById('rules-modal').classList.remove('hidden');
        }
        window.hideRules = () => {
            document.getElementById('rules-modal').classList.add('hidden');
        }

        // === JOIN OTIMIZADO ===
        window.joinGame = async () => {
            const name = document.getElementById('player-name-input').value.trim().toUpperCase();
            const roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();
            const statusDiv = document.getElementById('error-details');
            const statusBox = document.getElementById('connection-status');

            if (!name || roomCode.length < 3) { alert("Preencha nome e c√≥digo."); return; }

            statusBox.classList.remove('hidden');
            statusDiv.innerText = "Sincronizando via sat√©lite...";

            try {
                if (!auth.currentUser) await signInAnonymously(auth);
                myId = auth.currentUser.uid;
                myName = name;
                currentRoomId = roomCode;

                docRef = doc(db, 'artifacts', 'jogo-arquivo-morto', 'public', 'data', 'rooms', currentRoomId);

                // Listener em Tempo Real
                if (unsubscribeRoom) unsubscribeRoom();
                unsubscribeRoom = onSnapshot(docRef, (snap) => {
                    if (!snap.exists()) {
                        // Sala n√£o existe: Criar!
                        createRoom();
                    } else {
                        // Sala existe: Entrar se n√£o estiver nela
                        const data = snap.data();
                        localState = data;
                        
                        const playerExists = data.players.some(p => p.id === myId);
                        if (!playerExists) {
                            addSelfToRoom(data.players);
                        } else {
                            renderGame(localState);
                        }
                    }
                }, (error) => {
                    console.error("Erro no listener:", error);
                    // Mensagem de erro amig√°vel para problema de permiss√£o/configura√ß√£o
                    if (error.code === 'permission-denied' || error.code === 'unavailable') {
                        statusDiv.innerHTML = `<span class='font-bold text-red-600'>ERRO DE CONEX√ÉO:</span><br>O jogo n√£o conseguiu acessar o banco de dados.<br>1. Verifique se voc√™ configurou o "firebaseConfig" corretamente.<br>2. Verifique se o banco Firestore est√° criado no "Modo de Teste".`;
                    } else {
                        statusDiv.innerText = "Falha: " + error.code;
                    }
                });

            } catch (e) {
                console.error("Erro fatal:", e);
                // TRATAMENTO DE ERRO DE CONFIGURA√á√ÉO DE AUTH
                if (e.code === 'auth/configuration-not-found' || e.code === 'auth/operation-not-allowed' || e.code === 'auth/admin-restricted-operation') {
                    statusDiv.innerHTML = `<span class='font-bold text-red-600'>ERRO DE AUTENTICA√á√ÉO:</span><br>Falta ativar o Login An√¥nimo no console.<br>1. V√° em "Authentication" > "Sign-in method".<br>2. Ative o provedor "An√¥nimo".`;
                } else {
                    statusDiv.innerText = "Erro Cr√≠tico: " + e.message;
                }
            }
        };

        async function createRoom() {
            const newPlayer = { id: myId, name: myName, score: 0, hand: drawCards(6) };
            try {
                await setDoc(docRef, {
                    phase: 'lobby',
                    players: [newPlayer],
                    roundCount: 0,
                    witnessIndex: 0,
                    createdAt: new Date().toISOString()
                });
            } catch(e) {
                console.error("Erro ao criar sala. Verifique permiss√µes do Firestore:", e);
            }
        }

        async function addSelfToRoom(currentPlayers) {
            const newPlayer = { id: myId, name: myName, score: 0, hand: drawCards(6) };
            const updatedPlayers = [...currentPlayers, newPlayer];
            try {
                await updateDoc(docRef, { players: updatedPlayers });
            } catch(e) {
                console.error("Erro ao entrar na sala:", e);
            }
        }

        // === RENDERIZA√á√ÉO ===
        function renderGame(state) {
            if (state.phase === 'lobby') {
                document.getElementById('lobby-player-list').innerHTML = state.players.map(p => `<li>üëÆ ${p.name} ${p.id === myId ? '(VOC√ä)' : ''}</li>`).join('');
                document.getElementById('screen-login').classList.add('hidden');
                document.getElementById('screen-game').classList.add('hidden');
                document.getElementById('screen-lobby').classList.remove('hidden');
                document.getElementById('lobby-room-code').innerText = currentRoomId;
                return;
            }

            // JOGO
            document.getElementById('screen-login').classList.add('hidden');
            document.getElementById('screen-lobby').classList.add('hidden');
            document.getElementById('screen-game').classList.remove('hidden');

            const witness = state.players[state.witnessIndex];
            document.getElementById('current-witness-name').innerText = witness ? witness.name : "Ningu√©m";
            
            const me = state.players.find(p => p.id === myId);
            if(me) document.getElementById('my-score').innerText = me.score;

            const isWitness = (witness && myId === witness.id);
            const phaseDisplay = document.getElementById('game-phase-display');

            // Reset Visibilidade
            ['hand-area', 'word-selection-area', 'msg-container', 'voting-table', 'scoring-board', 'evidence-display', 'game-over-screen']
                .forEach(id => document.getElementById(id).classList.add('hidden'));

            if (state.phase === 'game_over') {
                phaseDisplay.innerText = "FIM";
                document.getElementById('game-over-screen').classList.remove('hidden');
                document.getElementById('action-area').classList.add('flex-col-reverse');
                if (state.winner) {
                    document.getElementById('winner-name').innerText = state.winner.name;
                    document.getElementById('winner-score').innerText = `${state.winner.score} Pontos`;
                }
                return;
            }

            if (state.phase === 'witness_setup') {
                phaseDisplay.innerText = "DEPOIMENTO";
                if (isWitness) {
                    document.getElementById('hand-area').classList.remove('hidden');
                    document.getElementById('hand-instruction').innerText = "A CARTA SECRETA";
                    document.getElementById('word-selection-area').classList.remove('hidden');
                    renderHand(me.hand, true);
                    renderWords();
                } else {
                    showMsg("Interrogat√≥rio", `${witness.name} est√° analisando os arquivos...`);
                }
            } else if (state.phase === 'detective_play') {
                phaseDisplay.innerText = "INVESTIGA√á√ÉO";
                showEvidence(state.currentWords);
                
                if (isWitness) {
                    // ALTERA√á√ÉO 3: Removida a tela de bloqueio (showMsg).
                    // Agora mostramos a mesa para a testemunha ver as cartas chegando.
                    document.getElementById('voting-table').classList.remove('hidden');
                    const tableTitle = document.querySelector('#voting-table h3');
                    tableTitle.innerText = "AGUARDANDO DETETIVES JOGAREM SUAS CARTAS...";
                    tableTitle.className = "text-white text-center mb-4 text-sm title-font bg-yellow-600/80 p-2 rounded animate-pulse";
                    
                    // Renderiza as cartas que j√° foram jogadas at√© agora
                    renderVotingTable(state.tableCards, false, null);
                } else {
                    if (state.playedThisRound.includes(myId)) {
                        showMsg("Evid√™ncia Enviada", "Aguardando os outros detetives.");
                    } else {
                        document.getElementById('hand-area').classList.remove('hidden');
                        document.getElementById('hand-instruction').innerText = "UMA CARTA PARA CONFUNDIR";
                        renderHand(me.hand, true);
                    }
                }
            } else if (state.phase === 'voting') {
                phaseDisplay.innerText = "VOTA√á√ÉO";
                showEvidence(state.currentWords);
                document.getElementById('voting-table').classList.remove('hidden');
                
                // Restaura o t√≠tulo padr√£o da mesa
                const tableTitle = document.querySelector('#voting-table h3');
                tableTitle.innerText = "QUEM √â A TESTEMUNHA? (VOTE)";
                tableTitle.className = "text-white text-center mb-4 text-xl title-font bg-red-900/80 p-2 rounded";

                if (isWitness) {
                    renderVotingTable(state.tableCards, false, null);
                    showMsg("Observando", "Voc√™ n√£o vota neste turno.");
                    document.getElementById('msg-container').style.backgroundColor = "rgba(0,0,0,0.1)";
                    document.getElementById('msg-container').style.pointerEvents = "none";
                    // Move a mensagem para baixo para n√£o tampar a mesa
                    document.querySelector('#msg-container > div').classList.add('mt-[400px]');
                } else {
                    // Garante que a mensagem esteja centralizada para quem vota
                    document.querySelector('#msg-container > div').classList.remove('mt-[400px]');
                    
                    if (state.votes && state.votes[myId]) {
                        showMsg("Voto Registrado", "Aguardando apura√ß√£o...");
                        renderVotingTable(state.tableCards, false, null);
                    } else {
                        const myCardId = state.tableCards.find(c => c.owner === myId)?.cardId;
                        renderVotingTable(state.tableCards, true, myCardId);
                    }
                }
            } else if (state.phase === 'scoring') {
                phaseDisplay.innerText = "RELAT√ìRIO";
                showEvidence(state.currentWords);
                document.getElementById('scoring-board').classList.remove('hidden');
                renderScoreboard(state);
            }
        }

        function showMsg(title, body) {
            const el = document.getElementById('msg-container');
            el.classList.remove('hidden');
            el.style.backgroundColor = "rgba(0,0,0,0.8)";
            el.style.pointerEvents = "auto";
            document.getElementById('msg-title').innerText = title;
            document.getElementById('msg-body').innerText = body;
        }

        function showEvidence(words) {
            document.getElementById('evidence-display').classList.remove('hidden');
            if(words && words.length >= 2) {
                document.getElementById('evidence-1').innerText = words[0];
                document.getElementById('evidence-2').innerText = words[1];
            }
        }

        function renderHand(cardIds, clickable) {
            const grid = document.getElementById('my-hand-grid');
            grid.innerHTML = '';
            cardIds.forEach(num => {
                const url = `https://github.com/carlossandressantos-cmyk/jogoarquivomorto/blob/main/${num}.png?raw=true`;
                const div = document.createElement('div');
                div.className = `card-frame rounded overflow-hidden aspect-[2/3] bg-gray-800 border-2 ${selectedCard === num ? 'card-selected' : 'border-gray-600'}`;
                div.innerHTML = `<img src="${url}" class="w-full h-full object-cover">`;
                if (clickable) {
                    div.onclick = () => {
                        selectedCard = num;
                        renderHand(cardIds, true);
                        if (localState.phase === 'witness_setup') checkWitnessReady();
                        if (localState.phase === 'detective_play') submitDetectiveCard(num);
                    };
                }
                grid.appendChild(div);
            });
        }

        function renderWords() {
            const grid = document.getElementById('word-grid');
            if (grid.children.length > 0) return;
            WORDS_LIST.forEach(word => {
                const btn = document.createElement('button');
                btn.className = "text-xs p-1 bg-gray-200 hover:bg-yellow-200 border border-gray-400";
                btn.innerText = word;
                btn.onclick = () => {
                    if (selectedWords.includes(word)) {
                        selectedWords = selectedWords.filter(w => w !== word);
                        btn.classList.remove('bg-red-800', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-black');
                    } else if (selectedWords.length < 2) {
                        selectedWords.push(word);
                        btn.classList.remove('bg-gray-200', 'text-black');
                        btn.classList.add('bg-red-800', 'text-white');
                    }
                    checkWitnessReady();
                };
                grid.appendChild(btn);
            });
        }

        function checkWitnessReady() {
            const btn = document.getElementById('btn-confirm-witness');
            btn.disabled = !(selectedCard && selectedWords.length === 2);
        }

        function renderVotingTable(cards, canVote, myOwnCardId) {
            const grid = document.getElementById('table-cards-grid');
            grid.innerHTML = '';
            cards.forEach(cardObj => {
                const url = `https://github.com/carlossandressantos-cmyk/jogoarquivomorto/blob/main/${cardObj.cardId}.png?raw=true`;
                const div = document.createElement('div');
                const isMine = (cardObj.cardId === myOwnCardId);
                div.className = `relative card-frame w-24 md:w-32 rounded overflow-hidden shadow-lg border-2 ${isMine ? 'border-yellow-500 opacity-80' : 'border-gray-200'}`;
                div.innerHTML = `
                    <img src="${url}" class="w-full h-full object-cover">
                    ${isMine ? '<div class="absolute bottom-0 w-full bg-yellow-500 text-black text-xs font-bold text-center">SUA CARTA</div>' : ''}
                `;
                if (canVote && !isMine) {
                    div.onclick = () => submitVote(cardObj.owner); 
                } else if (isMine) {
                    div.style.cursor = 'not-allowed';
                }
                grid.appendChild(div);
            });
        }

        function renderScoreboard(state) {
            const list = document.getElementById('scoreboard-list');
            const sorted = [...state.players].sort((a,b) => b.score - a.score);
            list.innerHTML = sorted.map((p, i) => 
                `<li class="flex justify-between border-b border-dashed border-gray-400 py-1">
                    <span>${i+1}. ${p.name}</span>
                    <span class="font-bold text-red-900">${p.score} pts</span>
                 </li>`
            ).join('');
            const witness = state.players[state.witnessIndex];
            document.getElementById('round-results').innerHTML = `
                <p><strong>A Testemunha:</strong> ${witness ? witness.name : 'N/A'}</p>
                <p><strong>Palavras:</strong> ${state.currentWords.join(" + ")}</p>
            `;
        }

        window.requestStartGame = async () => {
            // ALTERA√á√ÉO: MUDADO DE 3 PARA 1 PARA TESTES
            if (!localState || localState.players.length < 1) {
                alert("√â necess√°rio no m√≠nimo 1 agente.");
                return;
            }
            await updateDoc(docRef, {
                phase: 'witness_setup',
                witnessIndex: 0,
                roundCount: 1,
                currentWords: [],
                tableCards: [],
                votes: {},
                playedThisRound: []
            });
        };

        window.confirmWitnessPlay = async () => {
            if (!selectedCard || selectedWords.length !== 2) return;
            const me = localState.players.find(p => p.id === myId);
            const newHand = me.hand.filter(c => c !== selectedCard);
            const updatedPlayers = localState.players.map(p => p.id === myId ? { ...p, hand: newHand } : p);

            await updateDoc(docRef, {
                currentWords: selectedWords,
                tableCards: [{ cardId: selectedCard, owner: myId }], 
                players: updatedPlayers,
                playedThisRound: [myId],
                phase: 'detective_play'
            });
            selectedCard = null; selectedWords = [];
        };

        window.submitDetectiveCard = async (cardId) => {
            if(!confirm("Confirmar essa carta?")) return;
            const me = localState.players.find(p => p.id === myId);
            const newHand = me.hand.filter(c => c !== cardId);
            const updatedPlayers = localState.players.map(p => p.id === myId ? { ...p, hand: newHand } : p);
            
            const newTableCards = [...localState.tableCards, { cardId: cardId, owner: myId }];
            const newPlayedList = [...localState.playedThisRound, myId];
            const allPlayed = (newPlayedList.length === localState.players.length);

            let updates = { players: updatedPlayers, tableCards: newTableCards, playedThisRound: newPlayedList };
            if (allPlayed) {
                updates.phase = 'voting';
                updates.tableCards = newTableCards.sort(() => Math.random() - 0.5);
            }
            await updateDoc(docRef, updates);
            selectedCard = null;
        };

        window.submitVote = async (targetOwnerId) => {
            if (!confirm("Confirmar voto?")) return;
            const currentVotes = localState.votes || {};
            currentVotes[myId] = targetOwnerId;
            const detectiveCount = localState.players.length - 1;
            
            if (Object.keys(currentVotes).length >= detectiveCount) {
                calculateScores(currentVotes);
            } else {
                await updateDoc(docRef, { votes: currentVotes });
            }
        };

        async function calculateScores(finalVotes) {
            const players = [...localState.players];
            const witness = players[localState.witnessIndex];
            const detectives = players.filter(p => p.id !== witness.id);
            let witnessVotes = 0;
            
            Object.values(finalVotes).forEach(targetId => {
                if (targetId === witness.id) witnessVotes++;
            });

            if (witnessVotes === detectives.length || witnessVotes === 0) {
                // ALTERA√á√ÉO 2: Detetives ganham 3 pontos (era 2) ao achar a Testemunha
                detectives.forEach(d => { players.find(p => p.id === d.id).score += 3; });
                
                if (witnessVotes === 0) {
                     Object.values(finalVotes).forEach(targetId => {
                        const target = players.find(p => p.id === targetId);
                        if (target && target.id !== witness.id) target.score += 1;
                    });
                }
            } else {
                witness.score += 3;
                Object.entries(finalVotes).forEach(([voterId, targetId]) => {
                    if (targetId === witness.id) {
                        const d = players.find(p => p.id === voterId);
                        if(d) d.score += 3;
                    } else {
                        const target = players.find(p => p.id === targetId);
                        if (target) target.score += 1;
                    }
                });
            }

            players.forEach(p => { p.hand.push(drawCards(1)[0]); });

            const sorted = [...players].sort((a,b) => b.score - a.score);
            if (sorted[0].score >= WINNING_SCORE) {
                await updateDoc(docRef, { players: players, votes: finalVotes, phase: 'game_over', winner: sorted[0] });
            } else {
                await updateDoc(docRef, { players: players, votes: finalVotes, phase: 'scoring' });
            }
        }

        window.startNextRound = async () => {
            let nextIndex = localState.witnessIndex + 1;
            if (nextIndex >= localState.players.length) nextIndex = 0;
            await updateDoc(docRef, {
                phase: 'witness_setup',
                witnessIndex: nextIndex,
                roundCount: localState.roundCount + 1,
                currentWords: [],
                tableCards: [],
                votes: {},
                playedThisRound: []
            });
        };

        window.resetGameData = async () => {
            if(!confirm("Reiniciar jogo?")) return;
            await setDoc(docRef, { phase: 'lobby', players: [], roundCount: 0 });
            window.location.reload();
        }

        function drawCards(amount) {
            let cards = [];
            for(let i=0; i<amount; i++) cards.push(Math.floor(Math.random() * TOTAL_CARDS) + 1);
            return cards;
        }

        window.toggleAudio = function() {
            const audio = document.getElementById('bg-music');
            if (audio.paused) audio.play();
            else audio.pause();
        };

        generateRoomCode();
    </script>
</body>
</html>
